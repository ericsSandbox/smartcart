<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Detection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/dist/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            border: 2px solid #00ff00;
            padding: 15px;
            background: #0a0a0a;
            border-radius: 5px;
        }
        h2 {
            margin-top: 0;
            color: #ffff00;
        }
        #video-container {
            width: 100%;
            height: 400px;
            border: 2px solid #00ff00;
            background: #000;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #test-image {
            width: 100%;
            height: 400px;
            object-fit: contain;
            border: 2px solid #00ff00;
            background: #000;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .log {
            background: #000;
            border: 1px solid #00ff00;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border-radius: 3px;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .log-entry.success {
            color: #00ff00;
        }
        .log-entry.error {
            color: #ff0000;
        }
        .log-entry.info {
            color: #00ccff;
        }
        .log-entry.warning {
            color: #ffff00;
        }
        button {
            background: #00ff00;
            border: none;
            color: #000;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        button.danger {
            background: #ff0000;
        }
        button.danger:hover {
            background: #cc0000;
        }
        .status {
            padding: 10px;
            background: #001a00;
            border: 1px solid #00ff00;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Barcode Detection Test Suite</h1>
    
    <div class="container">
        <!-- Left: Live Camera -->
        <div class="section">
            <h2>üìπ Live Camera Feed</h2>
            <div id="video-container"></div>
            <div class="status">
                <strong>Camera Status:</strong> <span id="camera-status">Ready</span>
            </div>
            <button onclick="startCamera()">Start Camera</button>
            <button onclick="stopCamera()" class="danger">Stop Camera</button>
            
            <h3 style="margin-top: 20px; color: #ffff00;">Detection Log:</h3>
            <div class="log" id="camera-log"></div>
        </div>

        <!-- Right: Test Image Processing -->
        <div class="section">
            <h2>üñºÔ∏è Test Image Analysis</h2>
            <img id="test-image" src="" alt="Test barcode">
            <div class="status">
                <strong>Image Status:</strong> <span id="image-status">No image loaded</span>
            </div>
            <button onclick="loadTestImage()">Load Your Barcode Screenshot</button>
            <button onclick="analyzeImage()">Analyze Image</button>
            <button onclick="decodeImage()">Decode with html5-qrcode</button>
            
            <h3 style="margin-top: 20px; color: #ffff00;">Analysis Log:</h3>
            <div class="log" id="image-log"></div>
        </div>
    </div>

    <script>
        let cameraInstance = null;
        let testImage = null;
        let cameraLog = [];
        let imageLog = [];
        const MAX_LOGS = 100;

        function log(section, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArray = section === 'camera' ? cameraLog : imageLog;
            const logElement = document.getElementById(section + '-log');
            
            logArray.push({ time: timestamp, msg: message, type });
            if (logArray.length > MAX_LOGS) logArray.shift();
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function startCamera() {
            log('camera', 'üì∑ Starting camera...', 'info');
            document.getElementById('camera-status').textContent = 'Initializing...';
            
            try {
                if (typeof Html5Qrcode === 'undefined') {
                    throw new Error('Html5Qrcode library not loaded');
                }
                
                cameraInstance = new Html5Qrcode("video-container", {
                    formatsToSupport: ['QR_CODE', 'EAN_13', 'EAN_8', 'UPC_A', 'CODE_128', 'CODE_39']
                });

                log('camera', '‚úÖ Html5Qrcode instance created', 'success');

                const config = {
                    fps: 30,
                    qrbox: { width: 300, height: 300 },
                    rememberLastUsedCamera: true,
                    aspectRatio: 1.0,
                    showTorchButton: false,
                    disableFlip: false,
                    useBarCodeDetectorIfSupported: true
                };

                log('camera', 'Starting scanner with config: fps=30, box=300x300', 'info');

                await cameraInstance.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText, decodedResult) => {
                        log('camera', `üéØ DETECTED: "${decodedText}"`, 'success');
                        log('camera', `Format: ${decodedResult?.result?.format || 'unknown'}`, 'success');
                        log('camera', `Confidence: ${decodedResult?.result?.confidence || 'N/A'}`, 'success');
                    },
                    (errorMessage) => {
                        // Scanning frame - don't log every time to avoid spam
                    }
                );

                document.getElementById('camera-status').textContent = 'üü¢ ACTIVE - Point barcode at camera';
                log('camera', '‚úÖ Camera started successfully', 'success');

            } catch (err) {
                log('camera', `‚ùå Error: ${err.message}`, 'error');
                document.getElementById('camera-status').textContent = '‚ùå Error: ' + err.message;
            }
        }

        function stopCamera() {
            if (cameraInstance) {
                cameraInstance.stop().then(() => {
                    log('camera', '‚èπÔ∏è Camera stopped', 'info');
                    document.getElementById('camera-status').textContent = 'Stopped';
                    cameraInstance = null;
                }).catch(err => {
                    log('camera', `Error stopping: ${err}`, 'error');
                });
            }
        }

        function loadTestImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    testImage = event.target.result;
                    document.getElementById('test-image').src = testImage;
                    document.getElementById('image-status').textContent = 'Image loaded';
                    log('image', `‚úÖ Image loaded: ${file.name}`, 'success');
                    log('image', `Size: ${(file.size / 1024).toFixed(1)}KB`, 'info');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        async function analyzeImage() {
            if (!testImage) {
                log('image', '‚ùå No image loaded', 'error');
                return;
            }

            log('image', 'üîç Analyzing image...', 'info');

            try {
                const img = new Image();
                img.onload = () => {
                    log('image', `Image dimensions: ${img.width}x${img.height}`, 'info');
                    log('image', `Image loaded successfully`, 'success');

                    // Try to extract barcode region
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    // Get center region (where barcode likely is)
                    const centerX = img.width / 2;
                    const centerY = img.height / 2;
                    const boxSize = Math.min(img.width, img.height) * 0.6;

                    const imageData = ctx.getImageData(
                        centerX - boxSize/2,
                        centerY - boxSize/2,
                        boxSize,
                        boxSize
                    );

                    log('image', `Extracted center region: ${boxSize.toFixed(0)}x${boxSize.toFixed(0)}px`, 'info');
                    log('image', `Pixels analyzed: ${imageData.data.length / 4}`, 'info');
                };
                img.src = testImage;
            } catch (err) {
                log('image', `‚ùå Analysis error: ${err.message}`, 'error');
            }
        }

        async function decodeImage() {
            if (!testImage) {
                log('image', '‚ùå No image loaded', 'error');
                return;
            }

            log('image', 'üîÑ Decoding with html5-qrcode...', 'info');

            try {
                if (typeof Html5Qrcode === 'undefined') {
                    throw new Error('Html5Qrcode library not loaded');
                }

                log('image', 'Creating temporary decoder instance...', 'info');
                const decoder = new Html5Qrcode("test-image", {
                    formatsToSupport: ['QR_CODE', 'EAN_13', 'EAN_8', 'UPC_A', 'CODE_128', 'CODE_39']
                });

                log('image', 'Attempting to decode image...', 'info');
                const result = await Html5Qrcode.scanFile(testImage, true);

                log('image', `‚úÖ DECODE SUCCESS:`, 'success');
                log('image', `Text: "${result.decodedText}"`, 'success');
                log('image', `Format: ${result.decodedResult?.result?.format || 'unknown'}`, 'success');

            } catch (err) {
                log('image', `‚ö†Ô∏è Decode failed: ${err.message}`, 'warning');
                log('image', 'This could mean: image quality too low, barcode not in frame, or unsupported format', 'warning');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            log('camera', 'Test suite loaded. Click "Start Camera" to begin.', 'info');
            log('image', 'Click "Load Your Barcode Screenshot" to test image decoding.', 'info');
        });
    </script>
</body>
</html>
