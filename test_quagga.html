<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuaggaJS Barcode Detection Test</title>
    <!-- QuaggaJS - proven 1D barcode support -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            border: 2px solid #00ff00;
            padding: 15px;
            background: #0a0a0a;
            border-radius: 5px;
        }
        h2 {
            color: #ffff00;
            margin-top: 0;
        }
        #scanner {
            width: 100%;
            height: 400px;
            border: 2px solid #00ff00;
            background: #000;
            margin-bottom: 10px;
        }
        #test-image {
            width: 100%;
            height: 400px;
            object-fit: contain;
            border: 2px solid #00ff00;
            background: #000;
            margin-bottom: 10px;
        }
        .log {
            background: #000;
            border: 1px solid #00ff00;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border-radius: 3px;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .log-entry.success {
            color: #00ff00;
        }
        .log-entry.error {
            color: #ff0000;
        }
        .log-entry.info {
            color: #00ccff;
        }
        button {
            background: #00ff00;
            border: none;
            color: #000;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        button.danger {
            background: #ff0000;
        }
        button.danger:hover {
            background: #cc0000;
        }
        .status {
            padding: 10px;
            background: #001a00;
            border: 1px solid #00ff00;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç QuaggaJS Barcode Detection Test</h1>
    <p>Testing QuaggaJS (v0.12.1) - proven 1D barcode library</p>

    <div class="container">
        <!-- Left: Live Camera -->
        <div class="section">
            <h2>üìπ Live Camera Feed</h2>
            <div id="scanner"></div>
            <div class="status">
                <strong>Camera Status:</strong> <span id="camera-status">Ready</span>
            </div>
            <button onclick="startScanner()">Start Camera</button>
            <button onclick="stopScanner()" class="danger">Stop Camera</button>

            <h3 style="margin-top: 20px; color: #ffff00;">Detection Log:</h3>
            <div class="log" id="camera-log"></div>
        </div>

        <!-- Right: Test Image -->
        <div class="section">
            <h2>üñºÔ∏è Test Image Decoding</h2>
            <img id="test-image" src="" alt="Test barcode">
            <div class="status">
                <strong>Image Status:</strong> <span id="image-status">No image loaded</span>
            </div>
            <button onclick="loadTestImage()">Load Your Barcode Screenshot</button>
            <button onclick="decodeTestImage()">Decode Image</button>

            <h3 style="margin-top: 20px; color: #ffff00;">Decode Log:</h3>
            <div class="log" id="image-log"></div>
        </div>
    </div>

    <script>
        let cameraLog = [];
        let imageLog = [];
        let testImageData = null;
        let quaggaReady = false;
        let cameraActive = false;

        function cameraConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            cameraLog.push({ time: timestamp, msg: message, type });
            if (cameraLog.length > 100) cameraLog.shift();

            const log = document.getElementById('camera-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function imageConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            imageLog.push({ time: timestamp, msg: message, type });
            if (imageLog.length > 100) imageLog.shift();

            const log = document.getElementById('image-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        window.addEventListener('load', () => {
            cameraConsole('Checking for Quagga library...', 'info');
            
            // Check if Quagga loaded
            setTimeout(() => {
                if (typeof Quagga !== 'undefined') {
                    quaggaReady = true;
                    cameraConsole('‚úÖ Quagga library loaded!', 'success');
                } else {
                    cameraConsole('‚ùå Quagga library not found', 'error');
                }
            }, 500);

            imageConsole('üëÜ Upload your barcode image to test', 'info');
        });

        function startScanner() {
            if (!quaggaReady) {
                cameraConsole('‚ùå Quagga not ready', 'error');
                return;
            }

            if (cameraActive) {
                cameraConsole('Camera already running', 'info');
                return;
            }

            cameraConsole('üì∑ Initializing camera...', 'info');
            document.getElementById('camera-status').textContent = 'Initializing...';

            try {
                Quagga.init(
                    {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#scanner'),
                            constraints: {
                                width: 640,
                                height: 480,
                                facingMode: "environment"
                            }
                        },
                        decoder: {
                            readers: [
                                "ean_reader",
                                "ean_8_reader",
                                "upc_reader",
                                "upc_e_reader",
                                "code_128_reader",
                                "code_39_reader",
                                "code_39_vin_reader",
                                "codabar_reader",
                                "i2of5_reader"
                            ],
                            debug: {
                                showCanvas: true,
                                showPatterns: false,
                                showFrequency: false,
                                showIds: false
                            }
                        }
                    },
                    (err) => {
                        if (err) {
                            cameraConsole(`‚ùå Init error: ${err.message}`, 'error');
                            document.getElementById('camera-status').textContent = 'Error: ' + err.message;
                            return;
                        }

                        cameraConsole('‚úÖ Quagga initialized', 'success');
                        Quagga.start();
                        cameraActive = true;
                        document.getElementById('camera-status').textContent = 'üü¢ ACTIVE';

                        // Detection handler
                        Quagga.onDetected((result) => {
                            if (result.codeResult && result.codeResult.code) {
                                const code = result.codeResult.code;
                                const confidence = result.codeResult.confidence;
                                cameraConsole(`üéØ DETECTED: ${code} (confidence: ${confidence.toFixed(2)})`, 'success');

                                // Auto-stop on detection
                                stopScanner();
                            }
                        });

                        cameraConsole('üìπ Listening for barcodes...', 'info');
                    }
                );
            } catch (err) {
                cameraConsole(`‚ùå Error: ${err.message}`, 'error');
                document.getElementById('camera-status').textContent = 'Error: ' + err.message;
            }
        }

        function stopScanner() {
            if (!cameraActive) return;

            try {
                Quagga.stop();
                Quagga.offDetected();
                cameraActive = false;
                document.getElementById('camera-status').textContent = 'Stopped';
                cameraConsole('‚èπÔ∏è Camera stopped', 'info');
            } catch (err) {
                cameraConsole(`Error stopping: ${err.message}`, 'error');
            }
        }

        function loadTestImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    testImageData = evt.target.result;
                    document.getElementById('test-image').src = testImageData;
                    document.getElementById('image-status').textContent = `Loaded: ${file.name}`;
                    imageConsole(`‚úÖ Image loaded: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`, 'success');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        async function decodeTestImage() {
            if (!testImageData) {
                imageConsole('‚ùå No image loaded', 'error');
                return;
            }

            if (!quaggaReady) {
                imageConsole('‚ùå Quagga not ready', 'error');
                return;
            }

            imageConsole('üîÑ Decoding image with Quagga...', 'info');

            try {
                const img = new Image();
                img.onload = () => {
                    // Create canvas from image
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    imageConsole(`Image dimensions: ${img.width}x${img.height}`, 'info');

                    try {
                        // Use Quagga's decodeSingle for static image
                        Quagga.decodeSingle(
                            {
                                src: testImageData,
                                numOfWorkers: 1,
                                inputStream: {
                                    size: 800
                                },
                                decoder: {
                                    readers: [
                                        "ean_reader",
                                        "ean_8_reader",
                                        "upc_reader",
                                        "upc_e_reader",
                                        "code_128_reader",
                                        "code_39_reader",
                                        "codabar_reader",
                                        "i2of5_reader"
                                    ],
                                    debug: {
                                        showCanvas: true,
                                        showPatterns: false,
                                        showFrequency: false,
                                        showIds: false
                                    }
                                }
                            },
                            (result) => {
                                if (result.codeResult) {
                                    const code = result.codeResult.code;
                                    const format = result.codeResult.format;
                                    imageConsole(`‚úÖ SUCCESS! Code: ${code}`, 'success');
                                    imageConsole(`Format: ${format}`, 'success');
                                } else {
                                    imageConsole('‚ùå No barcode detected in image', 'error');
                                }
                            }
                        );
                    } catch (err) {
                        imageConsole(`Decode error: ${err.message}`, 'error');
                    }
                };
                img.src = testImageData;
            } catch (err) {
                imageConsole(`Error: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>
