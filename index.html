<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SmartCart">
    <meta name="theme-color" content="#3b82f6">
    <title>SmartCart - Household Shopping & Pantry Manager</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%233b82f6' width='180' height='180'/><text x='50%' y='50%' font-size='90' font-weight='bold' text-anchor='middle' dominant-baseline='central' fill='white'>üõí</text></svg>">
    <link rel="manifest" href="/smartcart/manifest.json">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- html5-qrcode: ZXing-based 1D/2D barcode scanner, optimized for mobile -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <!-- jsQR: Lightweight QR code decoder for fallback -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- Tesseract OCR: For optical character recognition of 1D barcodes -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f3f4f6;
            color: #111827;
            padding-bottom: 100px;
        }

        .safe-area-top {
            height: max(env(safe-area-inset-top, 0px), 8px);
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        }

        header {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .tab-nav {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
            padding: 0 8px;
        }

        .tab-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: white;
            color: #1e40af;
        }

        .tab-btn:active {
            opacity: 0.8;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }

        .stat-card .label {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .search-box {
            margin-bottom: 20px;
        }

        input[type="search"],
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 12px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #6b7280;
            text-transform: uppercase;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .item-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .item-card.low-stock {
            border-left: 4px solid #ef4444;
        }

        .item-card.expired {
            border-left: 4px solid #d97706;
            opacity: 0.7;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .item-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #6b7280;
        }

        .item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:active {
            background: #e5e7eb;
        }

        .qty-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }

        .delete-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 8px;
        }

        .delete-btn:active {
            background: #fecaca;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 16px;
            color: #0c4a6e;
        }

        .category-count {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .category-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-left: 4px;
        }

        .add-item-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
        }

        .add-item-btn:active {
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: flex-end;
        }

        .modal.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-content {
            background: white;
            width: 100%;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom, 0px));
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:active {
            opacity: 0.9;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }

        .btn-secondary:active {
            background: #d1d5db;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:active {
            background: #059669;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .warning-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            gap: 8px;
        }

        .warning-banner.danger {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .tabs-inline {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab-toggle {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .tab-toggle.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #3b82f6;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .product-result {
            background: #f0f9ff;
            border: 2px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .product-result strong {
            display: block;
            margin-bottom: 4px;
        }

        .product-result small {
            color: #6b7280;
            display: block;
        }

        .member-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .member-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .member-info {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        #cameraContainer {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        #cameraContainer.active {
            display: flex;
        }

        #qr-reader {
            flex: 1;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            object-fit: cover;
        }

        #qr-reader.active {
            display: block;
        }

        #scanStatus {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
            padding: 10px;
            font-size: 16px;
        }

        #scanStatus.success {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            animation: pulse 0.5s ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        #cameraControls {
            padding: 16px;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        #cameraControls button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        #cameraControls button:hover {
            background: #2563eb;
        }

        #cameraControls button:active {
            background: #1d4ed8;
        }

        #cameraSelect {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        #cameraSelect option {
            background: #1f2937;
            color: white;
        }

        #cameraControls button:active {
            opacity: 0.8;
            transform: scale(0.95);
        }

        #cameraControls button.close {
            background: #ef4444;
        }

        .scanner-hint {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            text-align: center;
            color: #fff;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: bounce 1s infinite;
            z-index: 5;
        }

        #scannerReticle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 100px;
            border: 3px solid #00ff00;
            border-radius: 8px;
            z-index: 8;
            box-shadow: 
                0 0 20px rgba(0, 255, 0, 0.5),
                inset 0 0 20px rgba(0, 255, 0, 0.2);
            pointer-events: none;
        }

        #scannerReticle::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 10px;
            background: #00ff00;
            border-radius: 0 0 4px 4px;
        }

        #scannerReticle::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 10px;
            background: #00ff00;
            border-radius: 4px 4px 0 0;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="safe-area-top"></div>
    
    <header>
        <h1>üõí SmartCart</h1>
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="pantry">üì¶ Pantry</button>
            <button class="tab-btn" data-tab="shopping">üõçÔ∏è Shopping</button>
            <button class="tab-btn" data-tab="members">üë• Members</button>
        </div>
    </header>

    <div class="container">
        <div class="tab-content active" id="pantry">
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalCount">0</div>
                    <div class="label">Items</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="lowStockCount">0</div>
                    <div class="label">Low Stock</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="expiredCount">0</div>
                    <div class="label">Expiring</div>
                </div>
            </div>

            <div id="warningBanner"></div>

            <div class="search-box">
                <input type="search" id="searchInput" placeholder="üîç Search pantry..." />
            </div>

            <div style="display: flex; gap: 8px; padding: 12px; background: #f0f9ff; border-radius: 8px; margin: 12px 12px 0 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="togglePantryView()" style="flex: 1; padding: 8px; font-size: 12px; min-width: 80px;" id="viewToggleBtn">üìÇ View: Categories</button>
                <button class="btn btn-primary" onclick="showDataStats()" style="flex: 1; padding: 8px; font-size: 12px; min-width: 80px;">üìä Stats</button>
                <button class="btn btn-secondary" onclick="exportDataAsJSON()" style="flex: 1; padding: 8px; font-size: 12px; min-width: 80px;">üíæ Backup</button>
                <button class="btn btn-secondary" onclick="exportDataAsCSV()" style="flex: 1; padding: 8px; font-size: 12px; min-width: 80px;">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="importDataFromJSON()" style="flex: 1; padding: 8px; font-size: 12px; min-width: 80px;">‚¨ÜÔ∏è Restore</button>
            </div>

            <div class="section-title">Pantry Items</div>
            <div class="item-list" id="itemList"></div>
            <div class="empty-state" id="emptyState">
                <div class="icon">üß≠</div>
                <p>Your pantry is empty</p>
            </div>
        </div>

        <div class="tab-content" id="shopping">
            <div class="search-box">
                <input type="search" id="shoppingSearch" placeholder="üîç Search lists..." />
            </div>

            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button class="btn btn-primary" onclick="mergeShoppingLists()" style="flex: 1; padding: 8px; font-size: 12px;">üîÄ Merge Lists</button>
            </div>

            <div class="section-title">Shopping Lists</div>
            <div id="shoppingLists" class="item-list"></div>
            <div class="empty-state" id="emptyShoppingState">
                <div class="icon">üìã</div>
                <p>No shopping lists. Create one!</p>
            </div>
        </div>

        <div class="tab-content" id="members">
            <div class="section-title">Household Members</div>
            <div id="membersList"></div>
            <div class="empty-state" id="emptyMembersState">
                <div class="icon">üë•</div>
                <p>No members added yet</p>
            </div>
        </div>
    </div>

    <button class="add-item-btn" id="addItemBtn" title="Add Item">+</button>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">Add Item to Pantry</div>
            
            <div class="tabs-inline">
                <button class="tab-toggle active" data-form="manual">üìù Manual</button>
                <button class="tab-toggle" data-form="barcode">üì± Scan</button>
            </div>

            <form id="addForm" class="form-section active" data-form="manual">
                <label>Item Name *</label>
                <input type="text" id="itemName" placeholder="e.g., Milk, Bread" required>
                
                <label>Quantity *</label>
                <input type="number" id="itemQty" placeholder="1" value="1" min="0.1" step="0.1" required>
                
                <label>Unit</label>
                <select id="itemUnit">
                    <option>unit</option>
                    <option>lb</option>
                    <option>oz</option>
                    <option>cup</option>
                    <option>ml</option>
                    <option>piece</option>
                </select>
                
                <label>Expires</label>
                <input type="date" id="itemExpires">
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>

            <div class="form-section" data-form="barcode" id="barcodeForm">
                <label>üì± Scan Barcode:</label>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="barcodeInput" placeholder="Or type barcode..." style="flex: 1;">
                    <button type="button" class="btn btn-primary" onclick="openCameraScanner()" style="flex: 0 0 auto;">üì∑</button>
                </div>
                <div id="scannerResult" style="margin-top: 16px;"></div>
                <div class="button-group" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelBarcodeBtn">Cancel</button>
                </div>
            </div>

            <div id="cameraContainer">
                <div id="scanStatus">üìπ Point barcode at center</div>
                <div id="qr-reader" class="active"></div>
                <div id="scannerReticle"></div>
                <div class="scanner-hint">Center barcode in frame</div>
                <div id="debugDisplay" style="position: fixed; top: 50px; left: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace; font-size: 11px; padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1001; display: none; border: 2px solid #0f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #0f0; padding-bottom: 8px;">
                        <strong>üîç DEBUG LOG</strong>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="copyDebugLog()" style="padding: 4px 8px; background: #0f0; color: #000; border: none; border-radius: 3px; font-size: 10px; font-weight: bold; cursor: pointer;">üìã Copy</button>
                            <button onclick="clearDebugLog()" style="padding: 4px 8px; background: #f00; color: #fff; border: none; border-radius: 3px; font-size: 10px; font-weight: bold; cursor: pointer;">Clear</button>
                            <button onclick="toggleDebugDisplay()" style="padding: 4px 8px; background: #00f; color: #fff; border: none; border-radius: 3px; font-size: 10px; font-weight: bold; cursor: pointer;">Hide</button>
                        </div>
                    </div>
                    <div id="debugLog" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                <button id="debugToggleBtn" onclick="toggleDebugDisplay()" style="position: fixed; bottom: 120px; right: 10px; padding: 8px 12px; background: #0f0; color: #000; border: none; border-radius: 5px; font-size: 12px; font-weight: bold; cursor: pointer; z-index: 1000; display: none;">üîç Show Log</button>
                <div id="cameraControls">
                    <select id="cameraSelect">
                        <option value="">üì∑ Select Camera</option>
                    </select>
                    <button type="button" class="close" onclick="closeCameraScanner()">‚úï Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">Add Member</div>
            <form id="addMemberForm">
                <label>Name *</label>
                <input type="text" id="memberName" placeholder="Name" required>
                
                <label>Age</label>
                <input type="number" id="memberAge" placeholder="Age">
                
                <label>Allergies (comma-separated)</label>
                <input type="text" id="memberAllergies" placeholder="e.g., peanuts, dairy">
                
                <label>Dietary Preferences</label>
                <input type="text" id="memberDiet" placeholder="e.g., vegan, vegetarian">
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="cancelMemberBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Persistent Debug Log Modal (not a standard modal to prevent auto-close) -->
    <div id="debugLogModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; animation: fadeIn 0.3s ease-out;">
        <div style="background: white; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #eee;">
                <span style="font-size: 18px; font-weight: bold;">üîç Scan Debug Log</span>
                <button type="button" onclick="document.getElementById('debugLogModal').style.display = 'none'" style="font-size: 24px; cursor: pointer; background: none; border: none; color: #666;">‚úï</button>
            </div>
            <div id="debugLogViewer" style="flex: 1; overflow-y: auto; background: #1a1a1a; color: #0f0; font-family: monospace; font-size: 12px; padding: 15px; white-space: pre-wrap; word-wrap: break-word; margin: 0;"></div>
            <div style="display: flex; gap: 10px; padding: 20px; border-top: 1px solid #eee;">
                <button type="button" onclick="copyDebugLogFromModal()" style="flex: 1; padding: 10px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">üìã Copy Log</button>
                <button type="button" onclick="clearDebugLog(); document.getElementById('debugLogViewer').textContent = ''; addDebugLog('Log cleared')" style="flex: 1; padding: 10px 16px; background: #f44336; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">üóëÔ∏è Clear</button>
                <button type="button" onclick="document.getElementById('debugLogModal').style.display = 'none'" style="flex: 1; padding: 10px 16px; background: #2196F3; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="shoppingListModal">
        <div class="modal-content">
            <div class="modal-header">Shopping List</div>
            
            <div class="tabs-inline" id="shoppingTabs">
                <button class="tab-toggle active" data-form="view">üìã View List</button>
                <button class="tab-toggle" data-form="add">‚ûï Add Items</button>
                <button class="tab-toggle" data-form="import">üìù Import</button>
                <button class="tab-toggle" data-form="recipes">üç≥ Find Recipes</button>
            </div>

            <!-- View/Edit Shopping List -->
            <div class="form-section active" data-form="view">
                <div id="shoppingListItems" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;"></div>
                <input type="text" id="shoppingListName" placeholder="List name..." style="width: 100%; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="cancelShoppingBtn">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createNewShoppingList()">Create New</button>
                </div>
            </div>

            <!-- Add Items to List -->
            <div class="form-section" data-form="add">
                <label>Add to: <strong id="currentListName"></strong></label>
                
                <!-- Preview of existing items -->
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; margin-bottom: 12px; max-height: 200px; overflow-y: auto;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #374151;">
                        Items already in list:
                    </div>
                    <div id="shoppingAddItemsPreview" style="font-size: 12px; color: #6b7280;">
                        <div style="padding: 8px; color: #999; font-style: italic;">Loading...</div>
                    </div>
                </div>

                <input type="text" id="shoppingItemName" placeholder="Item name..." />
                <input type="number" id="shoppingItemQty" placeholder="Quantity" value="1" min="0.1" step="0.1" />
                <select id="shoppingItemUnit">
                    <option>unit</option>
                    <option>lb</option>
                    <option>oz</option>
                    <option>cup</option>
                    <option>ml</option>
                    <option>piece</option>
                </select>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="switchShoppingTab('view')">Back</button>
                    <button type="button" class="btn btn-primary" onclick="addItemToShoppingList()">Add Item</button>
                </div>
            </div>

            <!-- Import Ingredients -->
            <div class="form-section" data-form="import">
                <label>Paste Ingredient List:</label>
                <textarea id="ingredientPasteArea" placeholder="Paste ingredients here, one per line:&#10;10 oz rice noodles&#10;1 lb ground beef&#10;soy sauce&#10;sugar&#10;salt&#10;pepper&#10;garlic&#10;green onions" style="width: 100%; height: 180px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px; margin-bottom: 12px; resize: vertical;"></textarea>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
                    üí° Paste ingredients with or without quantities:<br>
                    ‚Ä¢ "10 oz rice noodles" ‚Üí 10, oz<br>
                    ‚Ä¢ "1 lb beef" ‚Üí 1, lb<br>
                    ‚Ä¢ "soy sauce" ‚Üí 1, unit
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="switchShoppingTab('view')">Back</button>
                    <button type="button" class="btn btn-primary" onclick="importIngredients()">Import All</button>
                </div>
            </div>

            <!-- Recipe Search -->
            <div class="form-section" data-form="recipes">
                <input type="text" id="recipeSearch" placeholder="Search recipes (e.g., 'pasta', 'chicken')..." />
                <button type="button" class="btn btn-primary" onclick="searchRecipes()" style="width: 100%; margin-top: 10px;">üîç Search</button>
                <div id="recipeResults" style="max-height: 350px; overflow-y: auto; margin-top: 12px;"></div>
                <div class="button-group" style="margin-top: 16px;">
                    <button type="button" class="btn btn-secondary" onclick="switchShoppingTab('view')">Back</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION & INITIALIZATION
        // ============================================
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyANLrJ54KQJi2R4VaU02DsuA6GxGTO0BQ",
            authDomain: "smartcart-faf36.firebaseapp.com",
            projectId: "smartcart-faf36",
            storageBucket: "smartcart-faf36.firebasestorage.app",
            messagingSenderId: "36120215522",
            appId: "1:36120215522:web:720084b2c098555d89efe3"
        };
        
        // Initialize Firebase
        let db = null;
        let householdId = null;
        
        async function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Enable offline persistence
                await db.enablePersistence({
                    synchronizeTabs: true
                }).catch((err) => {
                    if (err.code === 'failed-precondition') {
                        console.warn('‚ö†Ô∏è Multiple tabs open, persistence only in first tab');
                    } else if (err.code === 'unimplemented') {
                        console.warn('‚ö†Ô∏è Browser does not support offline persistence');
                    }
                });
                
                // Get or create household ID from localStorage
                householdId = localStorage.getItem('smartcart_household_id');
                if (!householdId) {
                    householdId = 'household_' + Date.now();
                    localStorage.setItem('smartcart_household_id', householdId);
                }
                
                console.log('‚úÖ Firebase connected. Household ID:', householdId);
                return true;
            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
                return false;
            }
        }

        // ============================================
        // FIREBASE DATA LAYER - Real-time Sync
        // ============================================

        let pantryItems = [];
        let shoppingLists = [];
        let members = [];
        let scannerActive = false;
        let lastDetectedBarcode = null;
        
        // Firestore listeners (for cleanup)
        let pantryUnsubscribe = null;
        let shoppingUnsubscribe = null;
        let membersUnsubscribe = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase
            await initFirebase();
            
            // Set up real-time listeners
            setupFirestoreListeners();
            
            // Load initial data
            await loadData();
            setupEventListeners();
            
            // Initialize pantry view mode
            const viewMode = localStorage.getItem('pantryViewMode') || 'category';
            const btn = document.getElementById('viewToggleBtn');
            if (btn) {
                btn.textContent = viewMode === 'category' ? 'üìÇ View: Categories' : 'üìã View: Items';
            }
            
            renderUI();
            initScanner(); // Initialize barcode scanner
        });

        function setupFirestoreListeners() {
            if (!db || !householdId) return;
            
            // Listen to pantry changes in real-time
            pantryUnsubscribe = db.collection('households').doc(householdId)
                .collection('pantry')
                .onSnapshot((snapshot) => {
                    pantryItems = [];
                    snapshot.forEach((doc) => {
                        pantryItems.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('üîÑ Pantry updated:', pantryItems.length, 'items');
                    renderUI();
                }, (error) => {
                    console.error('Pantry listener error:', error);
                });
            
            // Listen to shopping lists changes in real-time
            shoppingUnsubscribe = db.collection('households').doc(householdId)
                .collection('shoppingLists')
                .onSnapshot((snapshot) => {
                    shoppingLists = [];
                    snapshot.forEach((doc) => {
                        shoppingLists.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('üîÑ Shopping lists updated:', shoppingLists.length, 'lists');
                    renderUI();
                }, (error) => {
                    console.error('Shopping lists listener error:', error);
                });
            
            // Listen to members changes in real-time
            membersUnsubscribe = db.collection('households').doc(householdId)
                .collection('members')
                .onSnapshot((snapshot) => {
                    members = [];
                    snapshot.forEach((doc) => {
                        members.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('üîÑ Members updated:', members.length, 'members');
                    renderUI();
                }, (error) => {
                    console.error('Members listener error:', error);
                });
        }

        async function loadData() {
            if (!db || !householdId) {
                console.error('Firebase not initialized');
                return;
            }
            
            try {
                // Load pantry items
                const pantrySnapshot = await db.collection('households').doc(householdId)
                    .collection('pantry').get();
                pantryItems = pantrySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load shopping lists
                const shoppingSnapshot = await db.collection('households').doc(householdId)
                    .collection('shoppingLists').get();
                shoppingLists = shoppingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load members
                const membersSnapshot = await db.collection('households').doc(householdId)
                    .collection('members').get();
                members = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log('üì¶ Initial load complete:', pantryItems.length, 'pantry,', 
                           shoppingLists.length, 'lists,', members.length, 'members');
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // ============================================
        // FIREBASE CRUD OPERATIONS
        // ============================================
        
        // Pantry operations
        async function addPantryItemToFirebase(item) {
            if (!db || !householdId) return null;
            try {
                const docRef = await db.collection('households').doc(householdId)
                    .collection('pantry').add({
                        name: item.name,
                        quantity: item.quantity || 1,
                        unit: item.unit || 'unit',
                        expires_at: item.expires_at || null,
                        category: item.category || null,
                        isStaple: item.isStaple || false,
                        created_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                console.log('‚úÖ Pantry item added:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error adding pantry item:', error);
                return null;
            }
        }
        
        async function updatePantryItemInFirebase(itemId, updates) {
            if (!db || !householdId) return false;
            try {
                await db.collection('households').doc(householdId)
                    .collection('pantry').doc(String(itemId)).update(updates);
                console.log('‚úÖ Pantry item updated:', itemId);
                return true;
            } catch (error) {
                console.error('Error updating pantry item:', error);
                alert('Error updating item: ' + error.message);
                return false;
            }
        }
        
        async function deletePantryItemFromFirebase(itemId) {
            if (!db || !householdId) return false;
            try {
                await db.collection('households').doc(householdId)
                    .collection('pantry').doc(String(itemId)).delete();
                console.log('‚úÖ Pantry item deleted:', itemId);
                return true;
            } catch (error) {
                console.error('Error deleting pantry item:', error);
                alert('Error deleting item: ' + error.message);
                return false;
            }
        }
        
        // Shopping list operations
        async function addShoppingListToFirebase(list) {
            if (!db || !householdId) return null;
            try {
                const docRef = await db.collection('households').doc(householdId)
                    .collection('shoppingLists').add({
                        name: list.name,
                        items: list.items || [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isMerged: list.isMerged || false,
                        sourceLists: list.sourceLists || []
                    });
                console.log('‚úÖ Shopping list added:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error adding shopping list:', error);
                return null;
            }
        }
        
        async function updateShoppingListInFirebase(listId, updates) {
            if (!db || !householdId) return false;
            try {
                await db.collection('households').doc(householdId)
                    .collection('shoppingLists').doc(listId).update(updates);
                console.log('‚úÖ Shopping list updated:', listId);
                return true;
            } catch (error) {
                console.error('Error updating shopping list:', error);
                return false;
            }
        }
        
        async function deleteShoppingListFromFirebase(listId) {
            if (!db || !householdId) return false;
            try {
                await db.collection('households').doc(householdId)
                    .collection('shoppingLists').doc(listId).delete();
                console.log('‚úÖ Shopping list deleted:', listId);
                return true;
            } catch (error) {
                console.error('Error deleting shopping list:', error);
                return false;
            }
        }
        
        // Member operations
        async function addMemberToFirebase(member) {
            if (!db || !householdId) return null;
            try {
                const docRef = await db.collection('households').doc(householdId)
                    .collection('members').add({
                        name: member.name,
                        age: member.age || null,
                        allergies: member.allergies || null,
                        dietary_pref: member.dietary_pref || null,
                        created_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                console.log('‚úÖ Member added:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error adding member:', error);
                return null;
            }
        }
        
        async function deleteMemberFromFirebase(memberId) {
            if (!db || !householdId) return false;
            try {
                await db.collection('households').doc(householdId)
                    .collection('members').doc(memberId).delete();
                console.log('‚úÖ Member deleted:', memberId);
                return true;
            } catch (error) {
                console.error('Error deleting member:', error);
                return false;
            }
        }

        // Import backup data to Firebase
        async function importToFirebase(pantry, shoppingLists, members) {
            if (!db || !householdId) {
                alert('‚ùå Firebase not initialized');
                return;
            }
            
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; min-width: 300px; text-align: center;';
            progressDiv.innerHTML = '<div style="font-size: 18px; font-weight: bold; margin-bottom: 20px;">Importing to Firebase...</div><div id="importProgress" style="color: #666;">Starting...</div>';
            document.body.appendChild(progressDiv);
            
            const updateProgress = (msg) => {
                document.getElementById('importProgress').innerHTML = msg;
            };
            
            try {
                // Clear existing data first
                updateProgress('Clearing old data...');
                const batch = db.batch();
                
                // Delete all existing pantry items
                const pantrySnapshot = await db.collection('households').doc(householdId).collection('pantry').get();
                pantrySnapshot.docs.forEach(doc => batch.delete(doc.ref));
                
                // Delete all existing shopping lists
                const shoppingSnapshot = await db.collection('households').doc(householdId).collection('shoppingLists').get();
                shoppingSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                
                // Delete all existing members
                const membersSnapshot = await db.collection('households').doc(householdId).collection('members').get();
                membersSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                
                await batch.commit();
                
                // Import pantry items
                updateProgress(`Importing ${pantry.length} pantry items...`);
                for (let i = 0; i < pantry.length; i++) {
                    const item = pantry[i];
                    await addPantryItemToFirebase(item);
                    if (i % 10 === 0) {
                        updateProgress(`Importing pantry ${i}/${pantry.length}...`);
                    }
                }
                
                // Import shopping lists
                updateProgress(`Importing ${shoppingLists.length} shopping lists...`);
                for (let list of shoppingLists) {
                    await addShoppingListToFirebase(list);
                }
                
                // Import members
                updateProgress(`Importing ${members.length} members...`);
                for (let member of members) {
                    await addMemberToFirebase(member);
                }
                
                updateProgress('‚úÖ Import complete!');
                
                setTimeout(() => {
                    document.body.removeChild(progressDiv);
                    alert(`‚úÖ Data imported to Firebase!\n\nPantry: ${pantry.length} items\nShopping Lists: ${shoppingLists.length} lists\nMembers: ${members.length} members\n\nAll devices will sync automatically!`);
                }, 1500);
                
            } catch (error) {
                console.error('Import error:', error);
                document.body.removeChild(progressDiv);
                alert('‚ùå Import failed: ' + error.message);
            }
        }

        // ===== DATA BACKUP & EXPORT FUNCTIONS =====
        
        function exportDataAsJSON() {
            const timestamp = new Date().toISOString().split('T')[0];
            const backup = {
                exportDate: new Date().toISOString(),
                appVersion: '2.0',
                data: {
                    pantry: pantryItems,
                    shoppingLists: shoppingLists,
                    members: members
                }
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `smartcart-backup-${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup downloaded: smartcart-backup-' + timestamp + '.json');
        }

        function exportDataAsCSV() {
            const timestamp = new Date().toISOString().split('T')[0];
            let csv = 'SMARTCART - PANTRY & SHOPPING DATA EXPORT\n';
            csv += 'Exported: ' + new Date().toLocaleString() + '\n';
            csv += '\n‚ö†Ô∏è  NOTE: This CSV is for VIEWING only. To restore data after cache clear,\n';
            csv += 'use the JSON BACKUP file (üíæ Backup button) with the ‚¨ÜÔ∏è Restore button.\n';
            csv += 'See HOW_TO_RESTORE.md for details.\n\n';
            csv += 'PANTRY INVENTORY EXPORT\n';
            csv += 'Exported: ' + new Date().toLocaleString() + '\n\n';
            csv += 'Item Name,Quantity,Unit,Category,Is Staple,Date Added\n';
            
            pantryItems.forEach(item => {
                const staple = item.isStaple ? 'YES' : 'NO';
                const dateAdded = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '';
                csv += `"${item.name}",${item.quantity},"${item.unit}","${item.category || ''}","${staple}","${dateAdded}"\n`;
            });
            
            csv += '\n\nSHOPPING LISTS SUMMARY\n';
            csv += 'List Name,Item Count,Completed Items,Creation Date\n';
            shoppingLists.forEach(list => {
                const completed = list.items.filter(i => i.completed).length;
                const total = list.items.length;
                const dateCreated = list.createdAt ? new Date(list.createdAt).toLocaleDateString() : '';
                csv += `"${list.name}",${total},${completed},"${dateCreated}"\n`;
            });
            
            // Detailed shopping items
            csv += '\n\nDETAILED SHOPPING ITEMS\n';
            csv += 'List Name,Item Name,Quantity,Unit,Completed,Added Date\n';
            shoppingLists.forEach(list => {
                list.items.forEach(item => {
                    const completed = item.completed ? 'YES' : 'NO';
                    csv += `"${list.name}","${item.name}",${item.quantity},"${item.unit}","${completed}","${item.createdAt || ''}"\n`;
                });
            });
            
            csv += '\n\nHOUSEHOLD MEMBERS\n';
            csv += 'Name,Age,Allergies,Dietary Preferences\n';
            members.forEach(member => {
                csv += `"${member.name}","${member.age || ''}","${member.allergies || ''}","${member.dietary_pref || ''}"\n`;
            });
            
            const dataBlob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `smartcart-data-${timestamp}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ CSV export downloaded: smartcart-data-' + timestamp + '.csv');
        }

        function importDataFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        console.log('Parsed backup file:', backup);
                        
                        // Validate backup structure - check if it has data property
                        if (!backup.data) {
                            alert('‚ùå Invalid backup file format: missing data object');
                            return;
                        }
                        
                        // Extract data with fallbacks
                        const newPantry = backup.data.pantry || [];
                        const newShoppingLists = backup.data.shoppingLists || [];
                        const newMembers = backup.data.members || [];
                        
                        console.log('Extracted data:', {
                            pantry: newPantry.length,
                            shoppingLists: newShoppingLists.length,
                            members: newMembers.length
                        });
                        
                        if (confirm('‚ö†Ô∏è This will REPLACE all current data in Firebase with the backup.\n\nAre you sure? This action cannot be undone.')) {
                            importToFirebase(newPantry, newShoppingLists, newMembers);
                        }
                    } catch (err) {
                        alert('‚ùå Error reading backup file: ' + err.message);
                        console.error('Import error:', err);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function getDataStats() {
            const pantryByCategory = {};
            pantryItems.forEach(item => {
                const cat = item.category || 'Uncategorized';
                pantryByCategory[cat] = (pantryByCategory[cat] || 0) + 1;
            });
            
            const shoppingStats = {
                totalLists: shoppingLists.length,
                totalItems: shoppingLists.reduce((sum, list) => sum + list.items.length, 0),
                completedItems: shoppingLists.reduce((sum, list) => sum + list.items.filter(i => i.completed).length, 0)
            };
            
            return {
                pantryCount: pantryItems.length,
                pantryByCategory: pantryByCategory,
                stapleCount: pantryItems.filter(i => i.isStaple).length,
                shoppingStats: shoppingStats,
                memberCount: members.length,
                lastUpdated: new Date().toLocaleString()
            };
        }

        function showDataStats() {
            const stats = getDataStats();
            let statsText = 'üìä DATA STATISTICS\n\n';
            statsText += 'PANTRY:\n';
            statsText += '  Total Items: ' + stats.pantryCount + '\n';
            statsText += '  Staple Items: ' + stats.stapleCount + '\n';
            statsText += '  Categories: ' + Object.keys(stats.pantryByCategory).length + '\n';
            
            if (Object.keys(stats.pantryByCategory).length > 0) {
                statsText += '\n  Items by Category:\n';
                Object.entries(stats.pantryByCategory).forEach(([cat, count]) => {
                    statsText += '    ‚Ä¢ ' + cat + ': ' + count + '\n';
                });
            }
            
            statsText += '\nSHOPPING:\n';
            statsText += '  Lists: ' + stats.shoppingStats.totalLists + '\n';
            statsText += '  Total Items: ' + stats.shoppingStats.totalItems + '\n';
            statsText += '  Completed: ' + stats.shoppingStats.completedItems + '\n';
            
            statsText += '\nOTHER:\n';
            statsText += '  Members: ' + stats.memberCount + '\n';
            statsText += '  Last Updated: ' + stats.lastUpdated;
            
            alert(statsText);
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    switchTab(tab);
                });
            });

            document.querySelectorAll('.tab-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const form = e.target.dataset.form;
                    switchFormTab(form);
                });
            });

            document.getElementById('addItemBtn').addEventListener('click', () => {
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab === 'pantry') {
                    document.getElementById('addModal').classList.add('active');
                } else if (activeTab === 'shopping') {
                    document.getElementById('shoppingListModal').classList.add('active');
                    renderShoppingListModal();
                } else if (activeTab === 'members') {
                    document.getElementById('addMemberModal').classList.add('active');
                }
            });

            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('addModal').classList.remove('active');
                document.getElementById('addForm').reset();
            });

            document.getElementById('cancelBarcodeBtn').addEventListener('click', () => {
                closeCameraScanner();
                document.getElementById('addModal').classList.remove('active');
                document.getElementById('scannerResult').innerHTML = '';
                document.getElementById('barcodeInput').value = '';
            });

            document.getElementById('cancelMemberBtn').addEventListener('click', () => {
                document.getElementById('addMemberModal').classList.remove('active');
                document.getElementById('addMemberForm').reset();
            });

            document.getElementById('cancelShoppingBtn').addEventListener('click', () => {
                document.getElementById('shoppingListModal').classList.remove('active');
                document.getElementById('shoppingListName').value = '';
            });

            document.getElementById('addForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addManualItem();
            });

            document.getElementById('addMemberForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addMember();
            });

            document.getElementById('barcodeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    scanBarcodeInput();
                }
            });

            document.getElementById('searchInput').addEventListener('input', () => {
                const viewMode = localStorage.getItem('pantryViewMode') || 'category';
                if (viewMode === 'category') {
                    renderPantryByCategory();
                } else {
                    renderPantry();
                }
            });

            document.getElementById('shoppingSearch').addEventListener('input', () => {
                renderShopping();
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        closeCameraScanner();
                    }
                });
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function switchFormTab(form) {
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.tab-toggle').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.form-section[data-form="${form}"]`).classList.add('active');
            event.target.classList.add('active');
        }

        let html5QrCode = null;
        let scannerStats = {
            framesProcessed: 0,
            detections: 0,
            startTime: null
        };

        let availableCameras = [];
        let currentCameraId = null;
        
        // Debug logging system
        const debugLog = [];
        function addDebugLog(msg) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${msg}`;
            debugLog.push(logEntry);
            if (debugLog.length > 15) debugLog.shift(); // Keep last 15 lines
            updateDebugDisplay();
            console.log(msg);
        }
        
        function updateDebugDisplay() {
            const display = document.getElementById('debugLog');
            if (display) {
                display.innerHTML = debugLog.map(line => `<div>${line}</div>`).join('');
                // Auto-scroll to bottom
                display.parentElement.scrollTop = display.parentElement.scrollHeight;
            }
        }
        
        function showDebugDisplay(show = true) {
            const display = document.getElementById('debugDisplay');
            const btn = document.getElementById('debugToggleBtn');
            if (display) {
                display.style.display = show ? 'block' : 'none';
                if (btn) btn.style.display = show ? 'none' : 'block';
            }
        }
        
        function toggleDebugDisplay() {
            const display = document.getElementById('debugDisplay');
            const btn = document.getElementById('debugToggleBtn');
            const isVisible = display.style.display !== 'none';
            display.style.display = isVisible ? 'none' : 'block';
            if (btn) btn.style.display = isVisible ? 'block' : 'none';
        }
        
        function copyDebugLog() {
            const logText = debugLog.join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                alert('üìã Debug log copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('‚ùå Could not copy log');
            });
        }
        
        function copyDebugLogFromModal() {
            const logText = document.getElementById('debugLogViewer').textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('üìã Debug log copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('‚ùå Could not copy log');
            });
        }
        
        function clearDebugLog() {
            debugLog.length = 0;
            updateDebugDisplay();
            addDebugLog('üóë Log cleared');
        }

        async function initScanner() {
            console.log('‚úÖ Barcode scanner initialized');
            console.log('Device:', navigator.userAgent);
            
            // Load available cameras
            await enumerateCameras();
        }

        async function enumerateCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameraSelect = document.getElementById('cameraSelect');
                
                // Get all video input devices
                const cameras = devices.filter(device => device.kind === 'videoinput');
                console.log(`Found ${cameras.length} camera(s):`, cameras.map(c => c.label || 'Unknown'));
                
                if (cameras.length === 0) {
                    console.log('‚ö†Ô∏è No cameras found');
                    return;
                }

                // Populate dropdown
                cameraSelect.innerHTML = '<option value="">üì∑ Select Camera</option>';
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    // Prefer rear/environment camera labels
                    const label = camera.label || `Camera ${index + 1}`;
                    option.textContent = label;
                    cameraSelect.appendChild(option);
                    console.log(`Camera ${index}: ${label}`);
                });

                // Auto-select first camera
                if (cameras.length > 0) {
                    currentCameraId = cameras[0].deviceId;
                    console.log('üì∑ Auto-selected first camera:', cameras[0].label);
                }

                // Handle camera selection
                cameraSelect.addEventListener('change', (e) => {
                    if (e.target.value) {
                        currentCameraId = e.target.value;
                        console.log('üì∑ Switched to camera:', e.target.value);
                        // Restart if scanner is active
                        if (scannerActive && html5QrCode) {
                            closeCameraScanner();
                            setTimeout(openCameraScanner, 500);
                        }
                    }
                });

            } catch (err) {
                console.error('Camera enumeration error:', err);
            }
        }

        async function openCameraScanner() {
            console.log('üì∑ Opening barcode scanner...');
            debugLog.length = 0; // Clear previous logs
            showDebugDisplay(true);
            addDebugLog('üì∑ Scanner opened');
            
            document.getElementById('cameraContainer').classList.add('active');
            document.getElementById('scanStatus').textContent = 'üìπ Requesting camera...';
            scannerActive = true;
            lastDetectedBarcode = null;

            try {
                // Get or create video element
                let videoElement = document.getElementById('qr-reader')?.querySelector('video');
                if (!videoElement) {
                    const qrReader = document.getElementById('qr-reader');
                    videoElement = document.createElement('video');
                    videoElement.setAttribute('playsinline', 'true');
                    videoElement.setAttribute('autoplay', 'true');
                    qrReader.appendChild(videoElement);
                }

                // Request camera access
                const cameraConstraint = currentCameraId 
                    ? { deviceId: { exact: currentCameraId } }
                    : { facingMode: 'environment' };

                console.log('üìπ Requesting camera with constraint:', cameraConstraint);
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: cameraConstraint,
                    audio: false
                });

                videoElement.srcObject = stream;
                videoElement.play().catch(err => console.error('Play error:', err));

                // Wait for video to load
                await new Promise(resolve => {
                    videoElement.onloadedmetadata = () => {
                        console.log(`‚úÖ Video loaded: ${videoElement.videoWidth}x${videoElement.videoHeight}`);
                        resolve();
                    };
                });

                document.getElementById('scanStatus').textContent = 'üìπ Point barcode at center...';

                // Start real-time barcode detection on stream
                startRealtimeBarcodeDetection(videoElement);

            } catch (err) {
                console.error('‚ùå Scanner error:', err);
                document.getElementById('scanStatus').textContent = '‚ùå ' + (err.message || 'Camera error');
                setTimeout(() => closeCameraScanner(), 2000);
            }
        }

        // Real-time barcode detection from video stream
        function startRealtimeBarcodeDetection(videoElement) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            canvas.width = videoElement.videoWidth || 640;
            canvas.height = videoElement.videoHeight || 480;

            let detectionActive = true;
            let lastDetectionTime = 0;
            let frameCount = 0;
            let consecutiveDetections = 0;
            let detectionHistory = []; // Track bar counts from recent frames
            const detectionThreshold = 3; // Require 3 consecutive frames
            const detectionCooldown = 2000; // 2 seconds between captures
            const barCountTolerance = 3; // Allow ¬±3 bars variation

            addDebugLog(`üì∏ Detection started (${canvas.width}x${canvas.height})`);

            const detectBarcode = () => {
                if (!detectionActive || !scannerActive) {
                    return;
                }

                try {
                    // Draw video frame to canvas
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                    frameCount++;

                    // Detect barcode pattern
                    const result = detectBarcodePattern(imageData, canvas.width, canvas.height);

                    if (frameCount % 60 === 0) {
                        addDebugLog(`Frame ${frameCount}: Score=${result.score.toFixed(2)}, Bars=${result.contrast}, Stripes=${result.stripesDetected}, ConsecDetect=${consecutiveDetections}, History=${JSON.stringify(detectionHistory)}`);
                    }

                    if (result.detected) {
                        // Track this detection's bar count
                        detectionHistory.push(result.contrast);
                        consecutiveDetections++;
                        
                        // Keep only the last 3 detections
                        if (detectionHistory.length > detectionThreshold) {
                            detectionHistory.shift();
                        }
                        
                        // Check if we have 3 consistent detections
                        if (consecutiveDetections >= detectionThreshold && detectionHistory.length === detectionThreshold) {
                            // Check if bar counts are consistent (within tolerance)
                            const minBars = Math.min(...detectionHistory);
                            const maxBars = Math.max(...detectionHistory);
                            const barsConsistent = (maxBars - minBars) <= barCountTolerance;
                            
                            if (barsConsistent) {
                                const now = Date.now();
                                if (now - lastDetectionTime > detectionCooldown) {
                                    const avgBars = Math.round(detectionHistory.reduce((a,b) => a+b) / detectionHistory.length);
                                    addDebugLog(`‚úÖ CONFIRMED! 3 frames (${detectionHistory[0]}, ${detectionHistory[1]}, ${detectionHistory[2]} bars) = ~${avgBars} bars`);
                                    detectionActive = false;
                                    captureAndSearchBarcode(canvas, videoElement);
                                    lastDetectionTime = now;
                                    consecutiveDetections = 0;
                                    detectionHistory = [];
                                }
                            } else {
                                addDebugLog(`‚ö†Ô∏è Bars inconsistent: ${detectionHistory.join(', ')} (range too wide)`);
                                consecutiveDetections = 0;
                                detectionHistory = [];
                            }
                        }
                    } else {
                        // Reset consecutive count if not detected
                        consecutiveDetections = 0;
                        detectionHistory = [];
                    }

                } catch (err) {
                    console.error('Detection error:', err);
                }

                if (detectionActive && scannerActive) {
                    requestAnimationFrame(detectBarcode);
                }
            };

            detectionActive = true;
            detectBarcode();
        }

        // Detect barcode-like patterns in image
        function detectBarcodePattern(imageData, width, height) {
            const data = imageData.data;

            // Convert to grayscale 
            const gray = new Uint8ClampedArray(width * height);
            for (let i = 0; i < data.length; i += 4) {
                gray[i / 4] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }

            // Sample lines in middle section
            const stripSamples = [];
            for (let i = 0; i < 10; i++) {
                stripSamples.push(Math.floor(height * (0.35 + (i * 0.03))));
            }

            let detectionCount = 0;
            let highScoreCount = 0;
            let maxScore = 0;
            let maxBars = 0;

            for (const y of stripSamples) {
                if (y < 0 || y >= height) continue;

                // Try multiple thresholds per line
                let bestScore = 0;
                let bestBars = 0;
                
                for (let thresholdVal of [80, 120, 160, 200]) {
                    // Get bar pattern from this line at this threshold
                    const barWidths = [];
                    let inBar = false;
                    let barWidth = 0;

                    for (let x = 0; x < width; x++) {
                        const isDark = gray[y * width + x] < thresholdVal;

                        if (isDark && !inBar) {
                            inBar = true;
                            barWidth = 1;
                        } else if (!isDark && inBar) {
                            barWidths.push(barWidth);
                            inBar = false;
                            barWidth = 0;
                        } else if (inBar) {
                            barWidth++;
                        }
                    }
                    if (inBar) barWidths.push(barWidth);

                    // REAL barcode criteria: 30-120 bars minimum
                    // EAN-13: ~95, UPC: ~95, CODE-128: ~67
                    if (barWidths.length >= 30 && barWidths.length <= 120) {
                        const mean = barWidths.reduce((a, b) => a + b) / barWidths.length;
                        const variance = barWidths.reduce((sum, w) => sum + Math.pow(w - mean, 2), 0) / barWidths.length;
                        const stdDev = Math.sqrt(variance);

                        // Barcodes have variation between thin and thick bars
                        if (stdDev > 1.0) {
                            const lineScore = Math.min(stdDev / 5, 1.0);
                            
                            if (lineScore > bestScore) {
                                bestScore = lineScore;
                                bestBars = barWidths.length;
                            }
                        }
                    }
                }

                // Only count strong detections
                if (bestScore > 0.5 && bestBars >= 30) {
                    detectionCount++;
                    maxBars = Math.max(maxBars, bestBars);
                    if (bestScore > 0.7) {
                        highScoreCount++;
                    }
                    maxScore = Math.max(maxScore, bestScore);
                }
            }

            // STRICT detection - requires 2+ strong lines AND 30+ bars
            const detected = (detectionCount >= 2 && maxBars >= 30);

            return {
                detected,
                score: maxScore,
                stripesDetected: detectionCount,
                contrast: maxBars
            };
        }

        // Capture snapshot and search for barcode using jsQR
        async function captureAndSearchBarcode(canvas, videoElement) {
            try {
                // Vibrate on detection
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }

                scannerActive = false;
                document.getElementById('scanStatus').textContent = 'üì∏ Analyzing barcode...';

                // Draw current frame
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                let barcodeValue = null;

                // Try jsQR first for QR codes - it's the most reliable
                if (typeof jsQR !== 'undefined') {
                    addDebugLog('üîç jsQR: Trying decoder...');
                    try {
                        const qrResult = jsQR(imageData.data, canvas.width, canvas.height, {
                            inverted: false
                        });
                        
                        if (qrResult && qrResult.data) {
                            barcodeValue = qrResult.data;
                            addDebugLog('‚úÖ jsQR DECODED: ' + barcodeValue);
                        } else {
                            addDebugLog('jsQR: No QR found');
                        }
                    } catch (e) {
                        addDebugLog('jsQR ERROR: ' + e.message);
                    }
                } else {
                    addDebugLog('‚ùå jsQR not available');
                }

                // Try with inverted colors (sometimes helps)
                if (!barcodeValue && typeof jsQR !== 'undefined') {
                    addDebugLog('üîç jsQR: Trying inverted...');
                    try {
                        const qrResult = jsQR(imageData.data, canvas.width, canvas.height, {
                            inverted: true
                        });
                        
                        if (qrResult && qrResult.data) {
                            barcodeValue = qrResult.data;
                            addDebugLog('‚úÖ jsQR DECODED (inv): ' + barcodeValue);
                        } else {
                            addDebugLog('jsQR: No QR (inv)');
                        }
                    } catch (e) {
                        addDebugLog('jsQR inv ERROR: ' + e.message);
                    }
                }

                // Try Tesseract OCR for 1D barcodes
                if (!barcodeValue && typeof Tesseract !== 'undefined') {
                    addDebugLog('üîÑ Tesseract: Starting OCR...');
                    try {
                        const result = await Tesseract.recognize(canvas, 'eng', {
                            logger: m => {
                                if (m.status === 'recognizing') {
                                    const progress = Math.round(m.progress * 100);
                                    if (progress % 25 === 0) {
                                        addDebugLog(`  OCR: ${progress}%`);
                                    }
                                }
                            }
                        });
                        
                        const text = result.data.text.trim();
                        addDebugLog('OCR text: ' + text.substring(0, 30));
                        
                        // Extract numeric sequences (barcodes)
                        const matches = text.match(/\d{8,}/g);
                        if (matches) {
                            addDebugLog(`Found ${matches.length} number sequences`);
                            const numeric = matches.sort((a, b) => b.length - a.length)[0];
                            if (numeric && numeric.length >= 8 && numeric.length <= 15) {
                                barcodeValue = numeric;
                                addDebugLog('‚úÖ OCR DECODED: ' + barcodeValue);
                            } else {
                                addDebugLog('Longest match invalid: ' + numeric);
                            }
                        } else {
                            addDebugLog('No numeric sequences found');
                        }
                    } catch (e) {
                        addDebugLog('OCR ERROR: ' + e.message);
                    }
                } else {
                    addDebugLog('‚ùå Tesseract not available');
                }

                // Fallback: Try canvas pattern analysis
                if (!barcodeValue) {
                    addDebugLog('üìä Manual extraction...');
                    barcodeValue = extractBarcodeFromCanvas(canvas);
                }

                if (barcodeValue) {
                    addDebugLog('‚úÖ FOUND: ' + barcodeValue);
                    document.getElementById('scanStatus').textContent = `‚úÖ Found: ${barcodeValue}`;
                    document.getElementById('scanStatus').classList.add('success');
                    document.getElementById('barcodeInput').value = barcodeValue;

                    setTimeout(() => {
                        closeCameraScanner();
                        scanBarcodeInput();
                    }, 1500);
                } else {
                    console.log('‚ö†Ô∏è Could not decode barcode');
                    document.getElementById('scanStatus').textContent = '‚ö†Ô∏è Decoding failed. Retrying...';
                    
                    // Resume scanning
                    setTimeout(() => {
                        scannerActive = true;
                        const videoElement = document.getElementById('qr-reader')?.querySelector('video');
                        if (videoElement && videoElement.srcObject) {
                            console.log('üîÑ Resuming detection...');
                            startRealtimeBarcodeDetection(videoElement);
                        }
                    }, 2000);
                }

            } catch (err) {
                console.error('Capture error:', err);
                document.getElementById('scanStatus').textContent = '‚ùå Error analyzing barcode';
                setTimeout(() => closeCameraScanner(), 2000);
            }
        }

        // Manual barcode extraction from canvas using pattern analysis
        function extractBarcodeFromCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // Convert to grayscale and binarize
            const gray = new Uint8ClampedArray(canvas.width * canvas.height);
            for (let i = 0; i < data.length; i += 4) {
                gray[i / 4] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }

            // Find barcode region by analyzing horizontal and vertical edges
            let maxEdges = 0;
            let bestY = 0;

            for (let y = Math.floor(canvas.height * 0.3); y < Math.floor(canvas.height * 0.7); y++) {
                let edges = 0;
                for (let x = 1; x < canvas.width - 1; x++) {
                    const diff = Math.abs(gray[y * canvas.width + x] - gray[y * canvas.width + x - 1]);
                    if (diff > 50) edges++;
                }
                if (edges > maxEdges) {
                    maxEdges = edges;
                    bestY = y;
                }
            }

            // Extract bar pattern from best line
            let barPattern = [];
            let inBar = false;
            let barWidth = 0;

            const y = bestY;
            for (let x = 0; x < canvas.width; x++) {
                const isDark = gray[y * canvas.width + x] < 100;
                
                if (isDark && !inBar) {
                    inBar = true;
                    barWidth = 1;
                } else if (!isDark && inBar) {
                    barPattern.push(barWidth);
                    inBar = false;
                } else if (inBar) {
                    barWidth++;
                }
            }

            if (barPattern.length > 0) {
                console.log(`üìä Extracted ${barPattern.length} bars from pattern`);
                // Return pattern as string for now (would need full EAN/UPC decoder for real extraction)
                return `BARCODE_${barPattern.length}_BARS`;
            }

            return null;
        }

        function closeCameraScanner() {
            console.log('üõë Closing scanner...');
            scannerActive = false;

            // Stop video stream
            const videoElement = document.getElementById('qr-reader')?.querySelector('video');
            if (videoElement && videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
                console.log('‚úÖ Video stream stopped');
            }

            // Stop html5-qrcode scanner if it exists
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    console.log('‚úÖ Scanner stopped');
                    html5QrCode = null;
                }).catch(err => {
                    console.error('Stop error:', err);
                    html5QrCode = null;
                });
            }

            // Reset UI
            document.getElementById('scanStatus').textContent = 'üì∑ Ready...';
            document.getElementById('scanStatus').classList.remove('success');
            document.getElementById('cameraContainer').classList.remove('active');
            
            // Show persistent debug log modal if there are logs
            const debugLogContent = document.getElementById('debugLog')?.textContent || '';
            if (debugLogContent.trim()) {
                document.getElementById('debugLogViewer').textContent = debugLogContent;
                document.getElementById('debugLogModal').style.display = 'flex';
            }
        }

        // Handle page visibility for camera lifecycle
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && html5QrCode) {
                console.log('üìµ Page hidden, stopping scanner');
                html5QrCode.stop().catch(err => console.log('Stop error:', err));
            }
        });

        window.scanBarcodeInput = async function() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            if (!barcode) return;

            const result = document.getElementById('scannerResult');
            result.innerHTML = '<div class="loading"><div class="spinner"></div> Looking up...</div>';

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const name = product.product_name || 'Unknown Product';
                    const quantity = product.quantity || '';
                    const brand = product.brands || '';

                    result.innerHTML = `
                        <div class="product-result">
                            <strong>‚úÖ ${name}</strong>
                            ${brand ? `<small>Brand: ${brand}</small>` : ''}
                            ${quantity ? `<small>Size: ${quantity}</small>` : ''}
                        </div>
                        <label>Quantity</label>
                        <input type="number" id="scannedQty" value="1" min="0.1" step="0.1" />
                        <label>Unit</label>
                        <select id="scannedUnit">
                            <option>unit</option>
                            <option>lb</option>
                            <option>oz</option>
                            <option>cup</option>
                            <option>ml</option>
                            <option>piece</option>
                        </select>
                        <label>Expires</label>
                        <input type="date" id="scannedExpires" />
                        <button class="btn btn-primary" onclick="addScannedItem('${name}')" style="margin-top: 12px; width: 100%;">Add to Pantry</button>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="warning-banner danger">
                            ‚ùå Product not found in database
                        </div>
                        <label>Enter Product Name:</label>
                        <input type="text" id="manualName" placeholder="e.g., Milk" />
                        <label>Quantity</label>
                        <input type="number" id="manualQty" value="1" min="0.1" step="0.1" />
                        <label>Unit</label>
                        <select id="manualUnit">
                            <option>unit</option>
                            <option>lb</option>
                            <option>oz</option>
                            <option>cup</option>
                            <option>ml</option>
                            <option>piece</option>
                        </select>
                        <button class="btn btn-primary" onclick="addManualScanned()" style="margin-top: 12px; width: 100%;">Add to Pantry</button>
                    `;
                }
            } catch (err) {
                console.error('Lookup error:', err);
                result.innerHTML = `
                    <div class="warning-banner danger">
                        ‚ö†Ô∏è Error looking up barcode
                    </div>
                    <label>Enter Product Name:</label>
                    <input type="text" id="manualName" placeholder="e.g., Milk" />
                    <label>Quantity</label>
                    <input type="number" id="manualQty" value="1" min="0.1" step="0.1" />
                    <button class="btn btn-primary" onclick="addManualScanned()" style="margin-top: 12px; width: 100%;">Add to Pantry</button>
                `;
            }
        };

        window.addScannedItem = async function(name) {
            // Check for duplicate
            const existing = findDuplicateItem(name);
            
            if (existing) {
                // Add to existing item
                const addQty = parseFloat(document.getElementById('scannedQty').value);
                const newQuantity = existing.quantity + addQty;
                await updatePantryItemInFirebase(existing.id, { quantity: newQuantity });
                alert(`‚úÖ Added ${addQty} unit(s) to existing "${existing.name}"\n\nNew total: ${newQuantity} ${existing.unit}`);
            } else {
                // Create new item
                const item = {
                    name: name,
                    quantity: parseFloat(document.getElementById('scannedQty').value),
                    unit: document.getElementById('scannedUnit').value,
                    expires_at: document.getElementById('scannedExpires').value || null
                };
                await addPantryItemToFirebase(item);
                alert(`‚ûï Created new entry: "${name}"`);
            }
            
            // Real-time listener will update UI automatically
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('scannerResult').innerHTML = '';
            document.getElementById('barcodeInput').value = '';
        };

        window.findDuplicateItem = function(itemName) {
            if (!itemName) return null;
            const nameLower = itemName.trim().toLowerCase();
            return pantryItems.find(item => item.name.toLowerCase() === nameLower);
        };

        window.addManualScanned = function() {
            const name = document.getElementById('manualName').value;
            if (!name) return;
            
            // Check for duplicate
            const existing = findDuplicateItem(name);
            
            if (existing) {
                // Add to existing item
                const addQty = parseFloat(document.getElementById('manualQty').value || 1);
                const newQuantity = existing.quantity + addQty;
                (async () => {
                    await updatePantryItemInFirebase(existing.id, { quantity: newQuantity });
                    alert(`‚úÖ Added ${addQty} unit(s) to existing "${existing.name}"\n\nNew total: ${newQuantity} ${existing.unit}`);
                })();
            } else {
                // Create new item
                const item = {
                    name: name,
                    quantity: parseFloat(document.getElementById('manualQty').value || 1),
                    unit: document.getElementById('manualUnit').value,
                    expires_at: null
                };
                (async () => {
                    await addPantryItemToFirebase(item);
                    alert(`‚ûï Created new entry: "${name}"`);
                })();
            }
            
            // Real-time listener will update UI automatically
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('scannerResult').innerHTML = '';
            document.getElementById('barcodeInput').value = '';
        };

        async function addManualItem() {
            const name = document.getElementById('itemName').value;
            if (!name) {
                alert('Please enter an item name');
                return;
            }
            
            // Check for duplicate
            const existing = findDuplicateItem(name);
            
            if (existing) {
                // Add to existing item
                const addQty = parseFloat(document.getElementById('itemQty').value || 1);
                const oldQty = existing.quantity;
                const newQty = oldQty + addQty;
                await updatePantryItemInFirebase(existing.id, { quantity: newQty });
                alert(`‚úÖ Smart Duplicate Detection!\n\nAdded ${addQty} unit(s) to existing "${existing.name}"\n\nOld total: ${oldQty} ${existing.unit}\nNew total: ${newQty} ${existing.unit}`);
            } else {
                // Create new item in Firebase
                const item = {
                    name: name,
                    quantity: parseFloat(document.getElementById('itemQty').value || 1),
                    unit: document.getElementById('itemUnit').value,
                    expires_at: document.getElementById('itemExpires').value || null
                };
                
                await addPantryItemToFirebase(item);
                alert(`‚ûï Created new entry: "${name}"`);
            }
            
            // Real-time listener will update UI automatically
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('addForm').reset();
        }

        async function addMember() {
            const member = {
                name: document.getElementById('memberName').value,
                age: document.getElementById('memberAge').value || null,
                allergies: document.getElementById('memberAllergies').value || null,
                dietary_pref: document.getElementById('memberDiet').value || null
            };
            
            await addMemberToFirebase(member);
            
            // Real-time listener will update UI automatically
            document.getElementById('addMemberForm').reset();
            document.getElementById('addMemberModal').classList.remove('active');
        }

        async function deletePantryItem(id) {
            console.log('deletePantryItem called:', id);
            if (confirm('Delete this item?')) {
                try {
                    await deletePantryItemFromFirebase(id);
                    // Real-time listener will update UI automatically
                } catch (error) {
                    console.error('Error in deletePantryItem:', error);
                    alert('Error deleting item: ' + error.message);
                }
            }
        }

        async function deleteMember(id) {
            if (confirm('Delete this member?')) {
                await deleteMemberFromFirebase(id);
                // Real-time listener will update UI automatically
            }
        }

        async function updateQuantity(id, change) {
            console.log('updateQuantity called:', id, change);
            const item = pantryItems.find(i => i.id === id);
            console.log('Found item:', item);
            if (item) {
                const newQuantity = Math.max(0, item.quantity + change);
                console.log('New quantity:', newQuantity);
                
                try {
                    // If item is marked as staple and quantity reaches 0, add to Staples list
                    if (newQuantity === 0 && item.isStaple) {
                        await addToStaplesList(item);
                        await deletePantryItem(id);
                    } else if (newQuantity === 0) {
                        await deletePantryItem(id);
                    } else {
                        await updatePantryItemInFirebase(id, { quantity: newQuantity });
                        // Real-time listener will update UI automatically
                    }
                } catch (error) {
                    console.error('Error in updateQuantity:', error);
                    alert('Error updating quantity: ' + error.message);
                }
            } else {
                console.error('Item not found with id:', id);
            }
        }

        async function toggleStaple(id) {
            const item = pantryItems.find(i => i.id === id);
            if (item) {
                await updatePantryItemInFirebase(id, { isStaple: !item.isStaple });
                // Real-time listener will update UI automatically
            }
        }

        async function addToStaplesList(item) {
            // Find or create Staples shopping list
            let staplesList = shoppingLists.find(l => l.name === '‚≠ê Staples');
            
            if (!staplesList) {
                staplesList = {
                    name: '‚≠ê Staples',
                    items: [],
                    createdAt: new Date().toISOString()
                };
                const docRef = await addShoppingListToFirebase(staplesList);
                staplesList.id = docRef.id;
            }
            
            // Add item to Staples list if not already there
            const exists = staplesList.items.find(si => si.name.toLowerCase() === item.name.toLowerCase());
            if (!exists) {
                const newItem = {
                    id: Date.now(),
                    name: item.name,
                    quantity: 1,
                    unit: item.unit || 'unit',
                    completed: false
                };
                staplesList.items.push(newItem);
                await updateShoppingListInFirebase(staplesList.id, { items: staplesList.items });
                // Real-time listener will update UI automatically
            }
        }

        function isExpired(expiryDate) {
            if (!expiryDate) return false;
            return new Date(expiryDate) < new Date();
        }

        function getExpiresIn(expiryDate) {
            if (!expiryDate) return null;
            const exp = new Date(expiryDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = exp - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'üî¥ Expired';
            if (diffDays === 0) return 'üü° Expires today';
            if (diffDays === 1) return 'üü° Expires tomorrow';
            if (diffDays <= 7) return `üü° ${diffDays}d`;
            return null;
        }

        // ==================== SMART CATEGORIZATION ====================
        
        const CATEGORY_PATTERNS = {
            'Spices': [
                'turmeric', 'ginger', 'cumin', 'paprika', 'cinnamon', 'nutmeg', 'clove',
                'oregano', 'basil', 'thyme', 'rosemary', 'sage', 'bay', 'pepper', 'chili',
                'cayenne', 'seasoning', 'spice', 'salt', 'allspice', 'coriander', 'cardamom',
                'fennel', 'caraway', 'dill', 'parsley', 'garlic powder', 'onion powder',
                'curry', 'garam masala', 'chinese 5', 'peruvian', 'saxon', 'tanjin',
                'taco', 'italian', 'peppercorn', 'mustard seed', 'celery salt',
                'ground ginger', 'ground cumin', 'ground coriander', 'ground cayenne', 'ground allspice',
                'ground cinnamon', 'ground nutmeg', 'ground turmeric', 'ground cardamom'
            ],
            'Proteins': [
                'chicken', 'beef', 'pork', 'turkey', 'bacon', 'ham', 'steak', 'fish', 
                'salmon', 'tuna', 'shrimp', 'crab', 'lobster', 'breast', 'roast', 'chop',
                'meatball', 'sausage', 'stew meat', 'ground beef', 'ground pork', 'ground turkey', 'ground chicken'
            ],
            'Vegetables': [
                'cucumber', 'onion', 'carrot', 'celery', 'lettuce', 'spinach', 'kale',
                'broccoli', 'cauliflower', 'cabbage', 'peppers', 'squash', 'zucchini',
                'tomato', 'corn', 'peas', 'beans', 'potato', 'leek', 'garlic', 'beet',
                'asparagus', 'green beans', 'mushroom', 'avocado', 'lemon', 'lime'
            ],
            'Condiments': [
                'ketchup', 'mayo', 'mayonnaise', 'mustard', 'sriracha', 'hot sauce',
                'sauce', 'dressing', 'ranch', 'vinaigrette', 'bbq', 'barbecue',
                'worcestershire', 'soy sauce', 'teriyaki', 'sweet chili', 'tahini',
                'peanut butter', 'horseradish', 'honey mustard', 'dijon', 'asian'
            ],
            'Oils & Vinegars': [
                'oil', 'grape seed', 'vegetable', 'olive', 'sesame', 'coconut',
                'vinegar', 'wine', 'apple cider', 'balsamic', 'rice', 'white', 'red'
            ],
            'Grains & Pasta': [
                'rice', 'basmati', 'jasmine', 'white rice', 'pasta', 'spaghetti',
                'noodle', 'egg noodles', 'penne', 'rigatoni', 'flour', 'wheat',
                'barley', 'lentil', 'bean', 'garbanzo', 'crackers', 'breadcrumb',
                'bread', 'bagel', 'pita'
            ],
            'Baking': [
                'baking', 'yeast', 'sugar', 'syrup', 'honey', 'maple', 'corn syrup',
                'cream of tartar', 'extract', 'vanilla', 'strawberry', 'mix', 'cake',
                'flour', 'brown sugar', 'superfine', 'granulated', 'chocolate'
            ],
            'Frozen': [
                'frozen', 'peas', 'pizza', 'pocket', 'hot pocket', 'lasagna',
                'ice', 'freezer', 'dough', 'pattie'
            ],
            'Bakery': [
                'bagel', 'bread', 'roll', 'croissant', 'pastry', 'wrapper', 'egg roll',
                'pita', 'tortilla', 'bun', 'breadcrumb', 'nutrigrain', 'bar'
            ],
            'Dairy & Cheese': [
                'milk', 'cheese', 'cream', 'yogurt', 'butter', 'whipped', 'sour',
                'parmesan', 'provolone', 'cheddar', 'mozzarella', 'swiss', 'feta',
                'ricotta', 'brie', 'gouda', 'egg', 'stick'
            ],
            'Pantry': [
                'crackers', 'granola', 'cereal', 'soup', 'beans', 'canned', 'coconut water',
                'vegetarian', 'baked beans', 'jam', 'jellied', 'grenadine', 'gravy'
            ],
            'Household': [
                'ziplock', 'plastic', 'wrap', 'foil', 'aluminum', 'parchment', 'bag',
                'paper', 'sandwich', 'gallon'
            ]
        };

        function autoCategorizePantryItem(itemName) {
            if (!itemName) return 'Pantry';
            const nameLower = itemName.toLowerCase();
            
            // Check for specific compound patterns first (e.g., "ground cumin" vs generic "ground")
            // This ensures "ground cumin" matches Spices before anything else
            const compoundPatterns = [
                'ground ginger', 'ground cumin', 'ground coriander', 'ground cayenne', 'ground allspice',
                'ground cinnamon', 'ground nutmeg', 'ground turmeric', 'ground cardamom',
                'ground beef', 'ground pork', 'ground turkey', 'ground chicken'
            ];
            
            for (const pattern of compoundPatterns) {
                if (nameLower.includes(pattern)) {
                    // Find which category this compound belongs to
                    for (const [category, patterns] of Object.entries(CATEGORY_PATTERNS)) {
                        if (patterns.includes(pattern)) {
                            return category;
                        }
                    }
                }
            }
            
            // Then check regular patterns
            for (const [category, patterns] of Object.entries(CATEGORY_PATTERNS)) {
                for (const pattern of patterns) {
                    if (nameLower.includes(pattern)) {
                        return category;
                    }
                }
            }
            return 'Pantry';
        }

        function migratePantryToCategories() {
            pantryItems.forEach(item => {
                if (!item.category) {
                    item.category = autoCategorizePantryItem(item.name);
                }
            });
        }

        function renderPantryByCategory() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            // Auto-categorize any items missing categories
            migratePantryToCategories();
            
            // Group items by category
            const grouped = {};
            pantryItems.forEach(item => {
                const cat = item.category || 'Pantry';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });
            
            // Filter by search - include items that match search term in name
            const filteredGrouped = {};
            Object.entries(grouped).forEach(([cat, items]) => {
                const filtered = items.filter(i => i.name.toLowerCase().includes(search));
                if (filtered.length > 0) {
                    filteredGrouped[cat] = filtered;
                }
            });
            
            const lowStock = pantryItems.filter(i => i.quantity <= 1).length;
            const expired = pantryItems.filter(i => isExpired(i.expires_at)).length;

            document.getElementById('totalCount').textContent = pantryItems.length;
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('expiredCount').textContent = expired;

            if (expired > 0 || lowStock > 0) {
                document.getElementById('warningBanner').innerHTML = `
                    ${expired > 0 ? `<div class="warning-banner danger">‚ö†Ô∏è ${expired} expired/expiring</div>` : ''}
                    ${lowStock > 0 ? `<div class="warning-banner">‚ÑπÔ∏è ${lowStock} low stock</div>` : ''}
                `;
            } else {
                document.getElementById('warningBanner').innerHTML = '';
            }

            if (Object.keys(filteredGrouped).length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('itemList').innerHTML = '';
            } else {
                document.getElementById('emptyState').style.display = 'none';
                
                // Sort categories in display order
                const categoryOrder = ['Proteins', 'Vegetables', 'Spices', 'Condiments', 'Oils & Vinegars', 'Grains & Pasta', 'Baking', 'Frozen', 'Bakery', 'Dairy & Cheese', 'Pantry', 'Household'];
                const sortedCategories = categoryOrder.filter(cat => filteredGrouped[cat]);
                
                const html = sortedCategories.map(cat => {
                    const items = filteredGrouped[cat];
                    const categoryEmojis = {
                        'Proteins': 'üçó',
                        'Vegetables': 'ü•¨',
                        'Spices': 'üßÇ',
                        'Condiments': 'üçØ',
                        'Oils & Vinegars': 'ü´í',
                        'Grains & Pasta': 'üåæ',
                        'Baking': 'üéÇ',
                        'Frozen': '‚ùÑÔ∏è',
                        'Bakery': 'ü•ñ',
                        'Dairy & Cheese': 'üßÄ',
                        'Pantry': 'üì¶',
                        'Household': 'üè†'
                    };
                    
                    // Load collapse state from localStorage (default: expanded)
                    const collapseKey = 'pantryCollapse_' + cat;
                    const isCollapsed = localStorage.getItem(collapseKey) === 'true';
                    
                    return `
                        <div class="category-section">
                            <div class="category-header" onclick="window.toggleCategoryCollapse('${cat}')" style="cursor: pointer; user-select: none;">
                                <span style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <span style="display: inline-block; width: 12px; text-align: center;">
                                        ${isCollapsed ? '‚ñ∂' : '‚ñº'}
                                    </span>
                                    <span>${categoryEmojis[cat] || 'üìÇ'} ${cat}</span>
                                </span>
                                <span class="category-count">${items.length}</span>
                            </div>
                            <div class="category-items" id="category-${cat.replace(/\s+/g, '-')}" style="display: ${isCollapsed ? 'none' : 'flex'}; ${isCollapsed ? 'overflow: hidden;' : ''}">
                                ${items.map(item => {
                                    const expired = isExpired(item.expires_at);
                                    const expiresIn = getExpiresIn(item.expires_at);
                                    let cardClass = 'item-card';
                                    if (expired) cardClass += ' expired';
                                    else if (item.quantity <= 1) cardClass += ' low-stock';

                                    return `
                                        <div class="${cardClass}">
                                            <div class="item-info">
                                                <div class="item-name">
                                                    ${item.name}
                                                    ${item.isStaple ? '<span style="margin-left: 8px; background: #fbbf24; color: #78350f; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">‚≠ê STAPLE</span>' : ''}
                                                </div>
                                                <div class="item-meta">
                                                    <span>üì¶ ${item.quantity} ${item.unit}</span>
                                                    ${expiresIn ? `<span>${expiresIn}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="item-qty">
                                                <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">‚àí</button>
                                                <div class="qty-display">${item.quantity}</div>
                                                <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                                                <button class="qty-btn" onclick="toggleStaple('${item.id}')" style="background: ${item.isStaple ? '#fbbf24' : '#e5e7eb'}; color: ${item.isStaple ? '#78350f' : '#6b7280'}; font-weight: bold;">‚≠ê</button>
                                                <button class="delete-btn" onclick="deletePantryItem('${item.id}')">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('itemList').innerHTML = html;
            }
        }

        window.toggleCategoryCollapse = function(category) {
            const collapseKey = 'pantryCollapse_' + category;
            const isCollapsed = localStorage.getItem(collapseKey) === 'true';
            const newState = !isCollapsed;
            localStorage.setItem(collapseKey, newState);
            
            // Update the display
            const categoryId = 'category-' + category.replace(/\s+/g, '-');
            const categoryItems = document.getElementById(categoryId);
            if (categoryItems) {
                categoryItems.style.display = newState ? 'none' : 'flex';
                // Update arrow
                const header = categoryItems.previousElementSibling;
                if (header) {
                    const arrow = header.querySelector('[style*="display: inline-block"]');
                    if (arrow) {
                        arrow.textContent = newState ? '‚ñ∂' : '‚ñº';
                    }
                }
            }
        };

        function renderUI() {
            // Check if we should show categorized view
            const viewMode = localStorage.getItem('pantryViewMode') || 'category';
            if (viewMode === 'category') {
                renderPantryByCategory();
            } else {
                renderPantry();
            }
            renderShopping();
            renderMembers();
        }

        function togglePantryView() {
            const viewMode = localStorage.getItem('pantryViewMode') || 'category';
            const newMode = viewMode === 'category' ? 'item' : 'category';
            localStorage.setItem('pantryViewMode', newMode);
            
            const btn = document.getElementById('viewToggleBtn');
            if (newMode === 'category') {
                btn.textContent = 'üìÇ View: Categories';
                renderPantryByCategory();
            } else {
                btn.textContent = 'üìã View: Items';
                renderPantry();
            }
        }

        function renderPantry() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = pantryItems.filter(i => i.name.toLowerCase().includes(search));
            
            const lowStock = pantryItems.filter(i => i.quantity <= 1).length;
            const expired = pantryItems.filter(i => isExpired(i.expires_at)).length;

            document.getElementById('totalCount').textContent = pantryItems.length;
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('expiredCount').textContent = expired;

            if (expired > 0 || lowStock > 0) {
                document.getElementById('warningBanner').innerHTML = `
                    ${expired > 0 ? `<div class="warning-banner danger">‚ö†Ô∏è ${expired} expired/expiring</div>` : ''}
                    ${lowStock > 0 ? `<div class="warning-banner">‚ÑπÔ∏è ${lowStock} low stock</div>` : ''}
                `;
            } else {
                document.getElementById('warningBanner').innerHTML = '';
            }

            if (filtered.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('itemList').innerHTML = '';
            } else {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('itemList').innerHTML = filtered.map(item => {
                    const expired = isExpired(item.expires_at);
                    const expiresIn = getExpiresIn(item.expires_at);
                    let cardClass = 'item-card';
                    if (expired) cardClass += ' expired';
                    else if (item.quantity <= 1) cardClass += ' low-stock';

                    return `
                        <div class="${cardClass}">
                            <div class="item-info">
                                <div class="item-name">
                                    ${item.name}
                                    ${item.isStaple ? '<span style="margin-left: 8px; background: #fbbf24; color: #78350f; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">‚≠ê STAPLE</span>' : ''}
                                </div>
                                <div class="item-meta">
                                    <span>üì¶ ${item.quantity} ${item.unit}</span>
                                    ${expiresIn ? `<span>${expiresIn}</span>` : ''}
                                </div>
                            </div>
                            <div class="item-qty">
                                <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">‚àí</button>
                                <div class="qty-display">${item.quantity}</div>
                                <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                                <button class="qty-btn" onclick="toggleStaple('${item.id}')" style="background: ${item.isStaple ? '#fbbf24' : '#e5e7eb'}; color: ${item.isStaple ? '#78350f' : '#6b7280'}; font-weight: bold;">‚≠ê</button>
                                <button class="delete-btn" onclick="deletePantryItem('${item.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderShopping() {
            const search = document.getElementById('shoppingSearch').value.toLowerCase();
            const filtered = shoppingLists.filter(l => l.name.toLowerCase().includes(search));

            if (filtered.length === 0) {
                document.getElementById('emptyShoppingState').style.display = 'block';
                document.getElementById('shoppingLists').innerHTML = '';
            } else {
                document.getElementById('emptyShoppingState').style.display = 'none';
                document.getElementById('shoppingLists').innerHTML = filtered.map(list => {
                    const completed = (list.items || []).filter(i => i.completed).length;
                    const total = (list.items || []).length;
                    return `
                        <div style="background: white; border-radius: 10px; padding: 12px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600;">${list.name}</div>
                                <button class="delete-btn" onclick="deleteShoppingList(${list.id})">üóëÔ∏è</button>
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                                ${total} items ‚Ä¢ ${completed} completed
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="openShoppingListToShop(${list.id})" style="flex: 1; padding: 8px; font-size: 12px;">üõí Shop</button>
                                ${completed === total && total > 0 ? `<button class="btn btn-secondary" onclick="renewShoppingList(${list.id})" style="flex: 1; padding: 8px; font-size: 12px;">üîÑ Renew</button>` : `<button class="btn btn-secondary" onclick="markShoppingDone(${list.id})" style="flex: 1; padding: 8px; font-size: 12px;">‚úì Done</button>`}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Merge multiple shopping lists into one master list - WITH LIST SELECTION
        function mergeShoppingLists() {
            if (shoppingLists.length < 2) {
                alert('You need at least 2 shopping lists to merge');
                return;
            }

            // Create a custom modal for list selection
            const listCheckboxes = shoppingLists.map((list, idx) => `
                <label style="display: flex; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; margin-bottom: 8px; cursor: pointer; border: 2px solid transparent;">
                    <input type="checkbox" class="merge-list-checkbox" data-index="${idx}" value="${list.id}" style="width: 18px; height: 18px; cursor: pointer; margin-right: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #1f2937;">${list.name}</div>
                        <div style="font-size: 12px; color: #6b7280;">${(list.items || []).length} items</div>
                    </div>
                </label>
            `).join('');

            // Create modal dialog
            const modalHtml = `
                <div id="mergeDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; border-radius: 10px; padding: 20px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                        <h2 style="margin: 0 0 8px 0; color: #1f2937;">Select Lists to Merge</h2>
                        <p style="color: #6b7280; font-size: 14px; margin: 0 0 16px 0;">Choose 2 or more lists to combine into a master list</p>
                        
                        <div style="margin-bottom: 16px; max-height: 300px; overflow-y: auto;">
                            ${listCheckboxes}
                        </div>

                        <label style="display: flex; align-items: center; margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #1f2937;">Name for merged list:</div>
                                <input type="text" id="mergeListNameInput" placeholder='e.g., "Weekly Shopping"' style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-top: 6px; font-size: 14px;">
                            </div>
                        </label>

                        <div style="display: flex; gap: 10px;">
                            <button onclick="document.getElementById('mergeDialog').remove()" style="flex: 1; padding: 10px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                            <button onclick="confirmMergeSelectedLists()" style="flex: 1; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üîÄ Merge Selected</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function confirmMergeSelectedLists() {
            // Get selected lists
            const selectedCheckboxes = document.querySelectorAll('.merge-list-checkbox:checked');
            
            if (selectedCheckboxes.length < 2) {
                alert('Please select at least 2 lists to merge');
                return;
            }

            const mergeName = document.getElementById('mergeListNameInput').value.trim();
            if (!mergeName) {
                alert('Please enter a name for the merged list');
                return;
            }

            // Get selected list IDs
            const selectedListIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const selectedLists = shoppingLists.filter(l => selectedListIds.includes(l.id));

            // Merge only selected lists
            const mergedItems = {};  // Track items and which lists they come from
            
            selectedLists.forEach(list => {
                (list.items || []).forEach(item => {
                    const itemKey = item.name.toLowerCase().trim();
                    
                    if (mergedItems[itemKey]) {
                        // Item exists - add to list count
                        mergedItems[itemKey].fromLists.add(list.id);
                    } else {
                        // New item
                        mergedItems[itemKey] = {
                            name: item.name,
                            quantity: item.quantity,
                            unit: item.unit,
                            completed: false,
                            fromLists: new Set([list.id])  // Track which lists it comes from
                        };
                    }
                });
            });

            // Convert to array with "x2", "x3" ONLY if duplicate across selected lists
            const mergedItemsArray = Object.values(mergedItems).map((item, idx) => {
                const count = item.fromLists.size;  // How many of the selected lists have this item
                return {
                    id: Date.now() + idx,
                    name: count > 1 ? `${item.name} x${count}` : item.name,
                    quantity: item.quantity,
                    unit: item.unit,
                    completed: false
                };
            });

            // Sort by category
            mergedItemsArray.sort((a, b) => {
                const catA = autoCategorizePantryItem(a.name);
                const catB = autoCategorizePantryItem(b.name);
                return catA.localeCompare(catB);
            });

            // Create new merged list
            const newMergedList = {
                id: Date.now(),
                name: mergeName,
                items: mergedItemsArray,
                createdAt: new Date().toISOString(),
                isMerged: true,
                sourceLists: selectedListIds
            };

            // Add merged list to Firebase
            (async () => {
                const docRef = await addShoppingListToFirebase(newMergedList);
                currentShoppingListId = docRef.id;
                
                // Close dialog
                const dialog = document.getElementById('mergeDialog');
                if (dialog) dialog.remove();
                
                // Open the merged list
                openShoppingListToShop(docRef.id);
                
                alert(`‚úÖ Created merged list "${mergeName}"\n\n${mergedItemsArray.length} total items\n${selectedLists.length} lists combined\n\nItems marked with x2, x3 appear in multiple lists`);
            })();
        }

        // Toggle shopping category collapse state
        window.toggleShoppingCategoryCollapse = function(category) {
            const collapseKey = 'shoppingCollapse_' + category;
            const isCollapsed = localStorage.getItem(collapseKey) === 'true';
            const newState = !isCollapsed;
            localStorage.setItem(collapseKey, newState);
            renderShoppingListDetailsByCategory();
        };

        // Render shopping list items organized by category
        function renderShoppingListDetailsByCategory() {
            if (!currentShoppingListId) return;
            const list = shoppingLists.find(l => l.id === currentShoppingListId);
            if (!list) return;

            // Group items by category
            const itemsByCategory = {};
            const categories = ['Proteins', 'Vegetables', 'Spices', 'Condiments', 'Oils & Vinegars', 'Grains & Pasta', 'Baking', 'Frozen', 'Bakery', 'Dairy & Cheese', 'Pantry', 'Household'];
            
            // Initialize categories
            categories.forEach(cat => {
                itemsByCategory[cat] = [];
            });

            // Categorize items
            (list.items || []).forEach(item => {
                const category = autoCategorizePantryItem(item.name);
                if (!itemsByCategory[category]) {
                    itemsByCategory[category] = [];
                }
                itemsByCategory[category].push(item);
            });

            // Sort categories to remove empty ones
            const activeCategories = categories.filter(cat => itemsByCategory[cat].length > 0);

            // Render categories with collapsible sections
            const categoriesHtml = activeCategories.map(cat => {
                const items = itemsByCategory[cat];
                const collapseKey = 'shoppingCollapse_' + cat;
                const isCollapsed = localStorage.getItem(collapseKey) === 'true';
                const categoryId = 'shoppingcategory-' + cat.replace(/\s+/g, '-');
                
                const itemsHtml = items.map(item => `
                    <div style="background: ${item.completed ? '#f0f0f0' : '#fafbfc'}; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; margin-bottom: 6px; display: flex; gap: 10px; align-items: center;">
                        <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleShoppingItem(${currentShoppingListId}, ${item.id})" style="width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; ${item.completed ? 'text-decoration: line-through; color: #999;' : ''}">${item.name}</div>
                            <div style="font-size: 12px; color: #6b7280;">${item.quantity} ${item.unit}</div>
                        </div>
                        <button onclick="removeShoppingItem(${currentShoppingListId}, ${item.id})" style="background: none; border: none; cursor: pointer; font-size: 18px;">üóëÔ∏è</button>
                    </div>
                `).join('');

                return `
                    <div id="${categoryId}" style="margin-bottom: 12px;">
                        <div onclick="window.toggleShoppingCategoryCollapse('${cat}')" style="cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f3f4f6; border-radius: 6px; font-weight: 600; user-select: none; margin-bottom: 8px;">
                            <span style="font-size: 14px;">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
                            <span>${cat}</span>
                            <span style="font-size: 12px; color: #6b7280; margin-left: auto;">${items.length} items</span>
                        </div>
                        <div style="display: ${isCollapsed ? 'none' : 'flex'}; flex-direction: column;">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('shoppingListItems').innerHTML = categoriesHtml || '<div style="text-align: center; color: #999; padding: 20px;">No items yet.</div>';
        }

        let currentShoppingListId = null;

        function renderShoppingListModal() {
            // Show list of all shopping lists to choose from
            const html = shoppingLists.map(list => `
                <div onclick="selectShoppingList(${list.id})" style="background: ${currentShoppingListId === list.id ? '#e0e7ff' : '#f9fafb'}; border: 2px solid ${currentShoppingListId === list.id ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer;">
                    <div style="font-weight: 600;">${list.name}</div>
                    <div style="font-size: 12px; color: #6b7280;">${(list.items || []).length} items</div>
                </div>
            `).join('');
            
            document.getElementById('shoppingListItems').innerHTML = html || '<div style="text-align: center; color: #999; padding: 20px;">No lists yet. Create one!</div>';
        }

        function selectShoppingList(listId) {
            currentShoppingListId = listId;
            const list = shoppingLists.find(l => l.id === listId);
            if (list) {
                document.getElementById('currentListName').textContent = list.name;
                renderShoppingListDetails();
            }
            renderShoppingListModal();
        }

        function renderShoppingListDetails() {
            // Use category-based rendering by default
            renderShoppingListDetailsByCategory();
        }

        function switchShoppingTab(tab) {
            document.querySelectorAll('#shoppingListModal .form-section').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('#shoppingListModal .tab-toggle').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`#shoppingListModal .form-section[data-form="${tab}"]`).classList.add('active');
            document.querySelector(`#shoppingListModal .tab-toggle[data-form="${tab}"]`).classList.add('active');
            
            if (tab === 'view') {
                renderShoppingListDetails();
            } else if (tab === 'add') {
                renderShoppingAddItemsPreview();
            }
        }

        function renderShoppingAddItemsPreview() {
            if (!currentShoppingListId) return;
            const list = shoppingLists.find(l => l.id === currentShoppingListId);
            if (!list) return;

            const items = list.items || [];
            
            if (items.length === 0) {
                document.getElementById('shoppingAddItemsPreview').innerHTML = '<div style="padding: 8px; color: #999; font-style: italic;">No items yet. Add your first item below!</div>';
                return;
            }

            const itemsHtml = items.map(item => `
                <div style="padding: 6px 8px; background: white; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #3b82f6;">
                    <div style="font-weight: 500; color: #1f2937;">${item.name}</div>
                    <div style="font-size: 11px; color: #9ca3af;">${item.quantity} ${item.unit}${item.completed ? ' ‚úì' : ''}</div>
                </div>
            `).join('');

            document.getElementById('shoppingAddItemsPreview').innerHTML = itemsHtml;
        }

        async function createNewShoppingList() {
            const name = document.getElementById('shoppingListName').value.trim();
            if (!name) {
                alert('Please enter a list name');
                return;
            }
            
            const newList = {
                name: name,
                items: [],
                createdAt: new Date().toISOString()
            };
            
            const docRef = await addShoppingListToFirebase(newList);
            currentShoppingListId = docRef.id;
            // Real-time listener will update UI automatically
            document.getElementById('shoppingListName').value = '';
            switchShoppingTab('add');
        }

        async function addItemToShoppingList() {
            if (!currentShoppingListId) {
                alert('Please select a list first');
                return;
            }

            const name = document.getElementById('shoppingItemName').value.trim();
            if (!name) {
                alert('Please enter an item name');
                return;
            }

            const list = shoppingLists.find(l => l.id === currentShoppingListId);
            if (list) {
                const item = {
                    id: Date.now(),
                    name: name,
                    quantity: parseFloat(document.getElementById('shoppingItemQty').value || 1),
                    unit: document.getElementById('shoppingItemUnit').value,
                    completed: false
                };
                
                list.items.push(item);
                await updateShoppingListInFirebase(list.id, { items: list.items });
                // Real-time listener will update UI automatically
                document.getElementById('shoppingItemName').value = '';
                document.getElementById('shoppingItemQty').value = '1';
                renderShoppingListDetails();
                renderShoppingAddItemsPreview();  // Update preview after adding
            }
        }

        async function toggleShoppingItem(listId, itemId) {
            const list = shoppingLists.find(l => l.id === listId);
            if (list) {
                const item = list.items.find(i => i.id === itemId);
                if (item) {
                    item.completed = !item.completed;
                    await updateShoppingListInFirebase(listId, { items: list.items });
                    // Real-time listener will update UI automatically
                    renderShoppingListDetails();
                }
            }
        }

        async function removeShoppingItem(listId, itemId) {
            const list = shoppingLists.find(l => l.id === listId);
            if (list) {
                list.items = list.items.filter(i => i.id !== itemId);
                await updateShoppingListInFirebase(listId, { items: list.items });
                // Real-time listener will update UI automatically
                renderShoppingListDetails();
            }
        }

        async function deleteShoppingList(listId) {
            if (confirm('Delete this shopping list?')) {
                await deleteShoppingListFromFirebase(listId);
                if (currentShoppingListId === listId) {
                    currentShoppingListId = null;
                }
                // Real-time listener will update UI automatically
            }
        }

        function openShoppingListToShop(listId) {
            currentShoppingListId = listId;
            const list = shoppingLists.find(l => l.id === listId);
            if (list) {
                document.getElementById('currentListName').textContent = list.name;
                document.getElementById('shoppingListModal').classList.add('active');
                switchShoppingTab('view');
                renderShoppingListDetails();
            }
        }

        async function markShoppingDone(listId) {
            const list = shoppingLists.find(l => l.id === listId);
            if (list) {
                // Mark all as completed
                list.items.forEach(i => i.completed = true);
                await updateShoppingListInFirebase(listId, { items: list.items });
                // Real-time listener will update UI automatically
            }
        }

        async function renewShoppingList(listId) {
            if (confirm('Reset all items to not completed? This will clear the shopping progress.')) {
                const list = shoppingLists.find(l => l.id === listId);
                if (list) {
                    list.items.forEach(i => i.completed = false);
                    await updateShoppingListInFirebase(listId, { items: list.items });
                    // Real-time listener will update UI automatically
                }
            }
        }

        async function toggleShoppingComplete(listId) {
            const list = shoppingLists.find(l => l.id === listId);
            if (list) {
                const completed = list.items.filter(i => i.completed).length;
                const total = list.items.length;
                
                if (completed === total && total > 0) {
                    // Mark all as incomplete
                    list.items.forEach(i => i.completed = false);
                } else {
                    // Mark all as complete
                    list.items.forEach(i => i.completed = true);
                }
                
                await updateShoppingListInFirebase(listId, { items: list.items });
                // Real-time listener will update UI automatically
            }
        }

        async function searchRecipes() {
            const query = document.getElementById('recipeSearch').value.trim();
            if (!query) {
                alert('Please enter a recipe search');
                return;
            }

            const resultsDiv = document.getElementById('recipeResults');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div> Searching...</div>';

            try {
                // Using TheMealDB API - completely free, no API key needed
                const response = await fetch(
                    `https://www.themealdb.com/api/json/v1/1/search.php?s=${encodeURIComponent(query)}`
                );
                const data = await response.json();

                if (data.meals && data.meals.length > 0) {
                    const html = data.meals.slice(0, 10).map(recipe => `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px;">
                                ${recipe.strMealThumb ? `<img src="${recipe.strMealThumb}" style="width: 60px; height: 60px; border-radius: 6px; object-fit: cover;">` : ''}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">${recipe.strMeal}</div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">${recipe.strCategory}${recipe.strArea ? ' ‚Ä¢ ' + recipe.strArea : ''}</div>
                                    <button class="btn btn-small btn-primary" onclick="window.open('https://www.themealdb.com/meal/${recipe.idMeal}', '_blank')" style="font-size: 12px; padding: 4px 8px;">View Recipe</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No recipes found. Try a different search!</div>';
                }
            } catch (error) {
                console.error('Recipe search error:', error);
                resultsDiv.innerHTML = `<div style="text-align: center; color: #d32f2f; padding: 20px;">‚ùå Search error: ${error.message}</div>`;
            }
        }

        function importIngredients() {
            if (!currentShoppingListId) {
                alert('Please select a list first');
                return;
            }

            const pastedText = document.getElementById('ingredientPasteArea').value.trim();
            if (!pastedText) {
                alert('Please paste ingredients');
                return;
            }

            const lines = pastedText.split('\n').filter(line => line.trim());
            const list = shoppingLists.find(l => l.id === currentShoppingListId);
            
            if (!list) {
                alert('List not found');
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;
            const skippedItems = [];
            const failedItems = [];

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Parse the line to extract quantity, unit, and item name
                const parsed = parseIngredientLine(line);
                
                if (parsed.name) {
                    // Extract base ingredient name (sanitized, without descriptors)
                    const baseIngredient = extractBaseIngredient(parsed.name);
                    
                    // Check if already in pantry
                    const inPantry = findDuplicateItem(baseIngredient);
                    
                    if (inPantry) {
                        // Item already in pantry, skip it
                        skippedCount++;
                        skippedItems.push(`${parsed.name} (pantry has: ${inPantry.quantity} ${inPantry.unit})`);
                    } else {
                        // Item not in pantry, add to shopping list
                        const item = {
                            id: Date.now() + Math.random(),
                            name: parsed.name,
                            quantity: parsed.quantity,
                            unit: parsed.unit,
                            completed: false
                        };
                        list.items.push(item);
                        addedCount++;
                    }
                } else {
                    failedItems.push(line);
                }
            });

            // Update shopping list in Firebase
            (async () => {
                await updateShoppingListInFirebase(list.id, { items: list.items });
            })();
            
            // Auto-select the shopping list and display it
            selectShoppingList(currentShoppingListId);
            renderShoppingListDetails();
            document.getElementById('ingredientPasteArea').value = '';

            let message = `‚úÖ Added ${addedCount} items to shopping list!`;
            if (skippedCount > 0) {
                message += `\n\n‚è≠Ô∏è Skipped ${skippedCount} items (already in pantry)`;
                if (skippedItems.length <= 5) {
                    message += ':\n' + skippedItems.map(i => '  ‚Ä¢ ' + i).join('\n');
                } else {
                    message += ':\n' + skippedItems.slice(0, 5).map(i => '  ‚Ä¢ ' + i).join('\n');
                    message += '\n  ... and ' + (skippedItems.length - 5) + ' more';
                }
            }
            if (failedItems.length > 0) {
                message += `\n\n‚ùå Couldn't parse ${failedItems.length} items. Try formatting as:\n"10 oz rice" or just "soy sauce"`;
            }
            alert(message);
            switchShoppingTab('view');
        }

        function extractBaseIngredient(ingredientName) {
            if (!ingredientName) return '';
            
            // Common multi-word ingredients that should NOT have descriptors removed
            const compoundIngredients = [
                'soy sauce', 'worcestershire sauce', 'hot sauce', 'apple sauce',
                'fish sauce', 'oyster sauce', 'teriyaki sauce', 'bbq sauce',
                'sweet chili sauce', 'sriracha sauce', 'tomato sauce', 'pizza sauce',
                'barbecue sauce', 'balsamic reduction', 'ranch dressing', 'honey mustard',
                'horseradish mustard', 'dijon mustard', 'yellow mustard',
                'ground beef', 'ground turkey', 'ground pork', 'ground chicken',
                'ground cumin', 'ground ginger', 'ground coriander',
                'frozen peas', 'frozen vegetables', 'frozen pizza', 'frozen peas',
                'cream cheese', 'whipped cream', 'sour cream',
                'olive oil', 'vegetable oil', 'sesame oil', 'coconut oil', 'grape seed oil',
                'apple cider vinegar', 'balsamic vinegar', 'rice vinegar', 'white vinegar',
                'red wine vinegar', 'wine vinegar',
                'parmesan cheese', 'cheddar cheese', 'mozzarella cheese', 'feta cheese',
                'chicken breast', 'chicken thigh', 'turkey breast', 'pork loin'
            ];
            
            let name = ingredientName.toLowerCase().trim();
            
            // Check if it's a known compound ingredient - return as-is
            for (const compound of compoundIngredients) {
                if (name.includes(compound)) {
                    return compound;
                }
            }
            
            // Common descriptors to remove
            const descriptors = [
                'ground', 'sliced', 'diced', 'minced', 'shredded', 'grated', 'chopped',
                'fresh', 'dried', 'frozen', 'canned', 'raw', 'cooked', 'roasted',
                'blanched', 'toasted', 'melted', 'softened', 'crushed', 'crumbled',
                'whole', 'half', 'pieces', 'piece', 'powder', 'paste', 'sauce',
                'extract', 'juice', 'zest', 'peel', 'rind', 'oil', 'liquid',
                'seedless', 'boneless', 'skinless', 'unsalted', 'salted', 'sweet',
                'hot', 'spicy', 'organic', 'grade', 'extra', 'pure', 'heavy',
                'light', 'low-fat', 'fat-free', 'reduced', 'whipped', 'sour',
                'plain', 'vanilla', 'chocolate', 'caramel', 'golden', 'dark',
                'white', 'brown', 'al dente'
            ];
            
            // Remove descriptors from the words
            const words = name.split(/\s+/);
            let cleanedWords = [];
            
            for (const word of words) {
                const cleanWord = word.replace(/[,;:]/g, ''); // Remove punctuation
                if (!descriptors.includes(cleanWord)) {
                    cleanedWords.push(word);
                }
            }
            
            // If all words were descriptors, return original
            if (cleanedWords.length === 0) {
                return name;
            }
            
            return cleanedWords.join(' ').trim();
        }

        function parseIngredientLine(line) {
            // Examples to handle:
            // "10 oz rice noodles" ‚Üí qty: 10, unit: oz, name: rice noodles
            // "1 lb ground beef" ‚Üí qty: 1, unit: lb, name: ground beef
            // "soy sauce" ‚Üí qty: 1, unit: unit, name: soy sauce
            // "0.5 cup sugar" ‚Üí qty: 0.5, unit: cup, name: sugar

            const trimmed = line.trim();
            if (!trimmed) return { name: null };

            // Common units to look for
            const units = ['oz', 'lb', 'g', 'kg', 'cup', 'cups', 'tbsp', 'tsp', 'ml', 'l', 'piece', 'pieces', 'can', 'jar', 'box', 'bag'];
            
            // Try to find quantity at the start
            const quantityMatch = trimmed.match(/^([\d.]+)\s*(?:x\s*)?(\w+)?\s+(.*)/);
            
            if (quantityMatch) {
                const qty = parseFloat(quantityMatch[1]);
                let unit = quantityMatch[2] || 'unit';
                let name = quantityMatch[3] || '';

                // Check if what we thought was quantity+unit is actually quantity+name
                if (unit && !units.includes(unit.toLowerCase())) {
                    // The "unit" is actually part of the name
                    name = (unit + ' ' + name).trim();
                    unit = 'unit';
                }

                // Normalize units
                if (unit === 'cups') unit = 'cup';
                if (unit === 'tbsp') unit = 'tbsp';
                if (unit === 'tsp') unit = 'tsp';
                if (unit === 'pieces') unit = 'piece';
                if (units.includes(unit.toLowerCase())) {
                    unit = unit.toLowerCase();
                }

                return {
                    quantity: isNaN(qty) ? 1 : qty,
                    unit: unit,
                    name: name.trim() || 'Item'
                };
            }

            // No quantity found, treat whole line as item name with default quantity
            return {
                quantity: 1,
                unit: 'unit',
                name: trimmed
            };
        }

        function renderMembers() {
            if (members.length === 0) {
                document.getElementById('emptyMembersState').style.display = 'block';
                document.getElementById('membersList').innerHTML = '';
            } else {
                document.getElementById('emptyMembersState').style.display = 'none';
                document.getElementById('membersList').innerHTML = members.map(member => `
                    <div class="member-card">
                        <div style="display: flex; justify-content: space-between;">
                            <div class="member-name">${member.name}</div>
                            <button class="delete-btn" onclick="deleteMember(${member.id})">üóëÔ∏è</button>
                        </div>
                        <div class="member-info">
                            ${member.age ? `<div>üéÇ Age: ${member.age}</div>` : ''}
                            ${member.allergies ? `<div>üö´ Allergies: ${member.allergies}</div>` : ''}
                            ${member.dietary_pref ? `<div>ü•ó Dietary: ${member.dietary_pref}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        // ===== SERVICE WORKER REGISTRATION =====
        // Enables offline-first functionality and app caching
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/smartcart/sw.js', {
                    scope: '/smartcart/'
                }).then((registration) => {
                    console.log('Service Worker registered successfully:', registration);
                }).catch((error) => {
                    console.log('Service Worker registration failed:', error);
                    // This is optional - app still works without it
                });
            });
        }
    </script>
</body>
</html>