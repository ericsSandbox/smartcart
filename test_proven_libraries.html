<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Barcode Detection Test - Proven Libraries</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .lib-test {
            border: 2px solid #00ff00;
            padding: 15px;
            margin: 15px 0;
            background: #0a0a0a;
            border-radius: 5px;
        }
        h2 {
            color: #ffff00;
            margin-top: 0;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid;
            border-radius: 3px;
        }
        .result.success {
            border-color: #00ff00;
            background: #001a00;
            color: #00ff00;
        }
        .result.error {
            border-color: #ff0000;
            background: #1a0000;
            color: #ff6666;
        }
        .result.info {
            border-color: #00ccff;
            background: #001a33;
            color: #00ccff;
        }
        button {
            background: #00ff00;
            border: none;
            color: #000;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            font-family: monospace;
        }
        button:hover {
            background: #00cc00;
        }
        .test-image {
            max-width: 300px;
            max-height: 300px;
            border: 1px solid #00ff00;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üî¨ Barcode Detection - Proven Libraries</h1>

    <!-- Test Image Upload -->
    <div class="lib-test">
        <h2>üì∏ Upload Test Image</h2>
        <input type="file" id="imageInput" accept="image/*">
        <img id="displayImage" class="test-image" style="display:none;">
        <div id="imageStatus"></div>
    </div>

    <!-- Library 1: Native Barcode Detection API -->
    <div class="lib-test">
        <h2>üìö Native Barcode Detection API (Built-in)</h2>
        <p>Chrome/Edge: Supports EAN, UPC, Code128, QR</p>
        <button onclick="testBarcodeDetectionAPI()">Test Native API</button>
        <div id="native-result"></div>
    </div>

    <!-- Library 2: Pyzbar.js (Python port) -->
    <div class="lib-test">
        <h2>üìö Pyzbar.js (Python ZBar port)</h2>
        <script src="https://cdn.jsdelivr.net/npm/pyzbar.js@0.1.3/index.js"></script>
        <button onclick="testPyzbar()">Test Pyzbar</button>
        <div id="pyzbar-result"></div>
    </div>

    <!-- Library 3: JSZbar (Direct ZBar binding) -->
    <div class="lib-test">
        <h2>üìö JSZbar (Direct ZBar)</h2>
        <button onclick="testJSZbar()">Test JSZbar</button>
        <div id="jszbar-result"></div>
    </div>

    <!-- Library 4: Quirc.js (1D barcode specialist) -->
    <div class="lib-test">
        <h2>üìö Quirc.js (1D Specialist)</h2>
        <script src="https://cdn.jsdelivr.net/npm/quirc.js@1.0.0/dist/quirc.min.js"></script>
        <button onclick="testQuirc()">Test Quirc</button>
        <div id="quirc-result"></div>
    </div>

    <!-- Library 5: Canvas pixel analysis (our custom approach) -->
    <div class="lib-test">
        <h2>üìö Custom Canvas + Pattern Recognition</h2>
        <button onclick="testCustomDecoder()">Test Custom Decoder</button>
        <div id="custom-result"></div>
    </div>

    <script>
        let uploadedImage = null;

        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                uploadedImage = evt.target.result;
                const img = document.getElementById('displayImage');
                img.src = uploadedImage;
                img.style.display = 'block';
                document.getElementById('imageStatus').innerHTML = 
                    `<div class="result info">‚úÖ Image loaded: ${file.name} (${(file.size/1024).toFixed(1)}KB)</div>`;
            };
            reader.readAsDataURL(file);
        });

        function resultDiv(elementId, success, message) {
            const div = document.getElementById(elementId);
            div.innerHTML = `<div class="result ${success ? 'success' : 'error'}">${success ? '‚úÖ' : '‚ùå'} ${message}</div>`;
        }

        // Test 1: Native Barcode Detection API
        async function testBarcodeDetectionAPI() {
            if (!uploadedImage) {
                resultDiv('native-result', false, 'No image uploaded');
                return;
            }

            try {
                if (!('BarcodeDetector' in window)) {
                    resultDiv('native-result', false, 'Native Barcode Detection API not supported in this browser');
                    return;
                }

                const img = new Image();
                img.onload = async () => {
                    try {
                        const barcodeDetector = new BarcodeDetector({
                            formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39']
                        });
                        const barcodes = await barcodeDetector.detect(img);
                        
                        if (barcodes.length > 0) {
                            const codes = barcodes.map(b => `${b.rawValue} (${b.format})`).join(', ');
                            resultDiv('native-result', true, `DECODED: ${codes}`);
                        } else {
                            resultDiv('native-result', false, 'No barcodes detected');
                        }
                    } catch (err) {
                        resultDiv('native-result', false, `Detection error: ${err.message}`);
                    }
                };
                img.src = uploadedImage;
            } catch (err) {
                resultDiv('native-result', false, `Setup error: ${err.message}`);
            }
        }

        // Test 2: Pyzbar
        async function testPyzbar() {
            if (!uploadedImage) {
                resultDiv('pyzbar-result', false, 'No image uploaded');
                return;
            }

            try {
                if (typeof pyzbar === 'undefined') {
                    resultDiv('pyzbar-result', false, 'Pyzbar library failed to load');
                    return;
                }

                const img = new Image();
                img.onload = async () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        const results = pyzbar.decode_canvas(canvas);
                        if (results && results.length > 0) {
                            const codes = results.map(r => `${r.data} (${r.type})`).join(', ');
                            resultDiv('pyzbar-result', true, `DECODED: ${codes}`);
                        } else {
                            resultDiv('pyzbar-result', false, 'No barcodes detected by Pyzbar');
                        }
                    } catch (err) {
                        resultDiv('pyzbar-result', false, `Decode error: ${err.message}`);
                    }
                };
                img.src = uploadedImage;
            } catch (err) {
                resultDiv('pyzbar-result', false, `Setup error: ${err.message}`);
            }
        }

        // Test 3: JSZbar
        async function testJSZbar() {
            resultDiv('jszbar-result', false, 'JSZbar not available via CDN - requires build');
        }

        // Test 4: Quirc
        async function testQuirc() {
            if (!uploadedImage) {
                resultDiv('quirc-result', false, 'No image uploaded');
                return;
            }

            try {
                if (typeof Quirc === 'undefined') {
                    resultDiv('quirc-result', false, 'Quirc library failed to load');
                    return;
                }

                const img = new Image();
                img.onload = async () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        // Quirc is for QR codes mainly
                        resultDiv('quirc-result', false, 'Quirc is primarily for QR codes, not 1D barcodes');
                    } catch (err) {
                        resultDiv('quirc-result', false, `Error: ${err.message}`);
                    }
                };
                img.src = uploadedImage;
            } catch (err) {
                resultDiv('quirc-result', false, `Setup error: ${err.message}`);
            }
        }

        // Test 5: Custom decoder - look for barcode patterns
        async function testCustomDecoder() {
            if (!uploadedImage) {
                resultDiv('custom-result', false, 'No image uploaded');
                return;
            }

            try {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // Find barcode area (high vertical line density)
                    let maxScore = 0;
                    let bestY = 0;
                    
                    for (let y = 0; y < canvas.height; y++) {
                        let lineScore = 0;
                        for (let x = 0; x < canvas.width; x++) {
                            const idx = (y * canvas.width + x) * 4;
                            const gray = (data[idx] + data[idx+1] + data[idx+2]) / 3;
                            
                            // Count high contrast vertical elements
                            if (x > 0) {
                                const prevGray = (data[(y * canvas.width + x - 1) * 4] + 
                                                data[(y * canvas.width + x - 1) * 4 + 1] + 
                                                data[(y * canvas.width + x - 1) * 4 + 2]) / 3;
                                if (Math.abs(gray - prevGray) > 80) {
                                    lineScore++;
                                }
                            }
                        }
                        
                        if (lineScore > maxScore) {
                            maxScore = lineScore;
                            bestY = y;
                        }
                    }

                    if (maxScore > 200) {
                        resultDiv('custom-result', true, `Found barcode pattern at y=${bestY}, score=${maxScore.toFixed(0)}`);
                    } else {
                        resultDiv('custom-result', false, `Insufficient barcode pattern (score ${maxScore.toFixed(0)} < 200)`);
                    }
                };
                img.src = uploadedImage;
            } catch (err) {
                resultDiv('custom-result', false, `Error: ${err.message}`);
            }
        }

        window.addEventListener('load', () => {
            document.getElementById('imageStatus').innerHTML = 
                `<div class="result info">üëÜ Upload your barcode image to test libraries</div>`;
        });
    </script>
</body>
</html>
